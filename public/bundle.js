(()=>{"use strict";(()=>{var t,e=function(){function t(){}return t.prototype.getSprite=function(){return this.sprite},t.prototype.getUSprite=function(){return this.spriteWhenUsed},t.prototype.setSprite=function(t){this.sprite=t},t.prototype.setUSprite=function(t){this.spriteWhenUsed=t},t}();!function(t){t[t.N=0]="N",t[t.E=1]="E",t[t.S=2]="S",t[t.W=3]="W",t[t.NE=4]="NE",t[t.SE=5]="SE",t[t.SW=6]="SW",t[t.NW=7]="NW"}(t||(t={}));var n,o,i=function(){function t(t,e){this.x=t,this.y=e}return t.prototype.equals=function(t){return this.x==t.x&&this.y==t.y},t.prototype.compare=function(t){return this.equals(t)?0:this.x<t.x||this.x==t.x&&this.y<t.y?-1:1},t.prototype.toString=function(){return"(".concat(this.x,", ").concat(this.y,")")},t}(),s=function(e,n){var o=new i(e.x,e.y);switch(n){case t.N:o.y--;break;case t.NE:o.x++,o.y--;break;case t.E:o.x++;break;case t.SE:o.x++,o.y++;break;case t.S:o.y++;break;case t.SW:o.x--,o.y++;break;case t.W:o.x--;break;case t.NW:o.x--,o.y--}return o},r=function(e,n){var o=n.x-e.x,i=n.y-e.y;return o>0&&i>0?t.SE:0==o&&i>0?t.S:o<0&&i>0?t.SW:o<0&&0==i?t.W:o<0&&i<0?t.NW:0==o&&i<0?t.N:o>0&&i<0?t.NE:t.E},a=function(t,e){return Math.abs(t.x-e.x)<=1&&Math.abs(t.y-e.y)<=1},c=function(){return Math.floor(8*Math.random())},h=(n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},n(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function o(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}),p=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n.pos=new i(0,0),n.prevDir=t.S,n}return h(n,e),n.prototype.setPos=function(t){this.pos=t},n.prototype.getDir=function(){return this.prevDir},n.prototype.getPos=function(){return this.pos},n}(e),u=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();!function(t){t[t.RANDOM=0]="RANDOM",t[t.ORDER=1]="ORDER"}(o||(o={}));var l,y,m=function(t){function e(){var e=t.call(this)||this;return e.phrases=[],e.tType=o.RANDOM,e.phraseIndex=0,e.phraseCount=0,e.name="",e}return u(e,t),e.prototype.changeStat=function(t,e){},e.prototype.act=function(){var t;null===(t=this.strategy)||void 0===t||t.execute()},e.prototype.move=function(t){var e=s(this.pos,t);this.movePos(e)},e.prototype.movePos=function(t){var e=pt.getInstance().getField();e.isInField(t)&&e.cellAt(t).isFree()&&(e.cellAt(this.pos).setEntity(null),e.cellAt(t).setEntity(this),this.prevDir=r(this.pos,t),this.pos=t)},e.prototype.setPhrases=function(t){this.phrases=t,this.phraseCount=t.length},e.prototype.getPhrases=function(){return this.phrases},e.prototype.getPhraseCount=function(){return this.phraseCount},e.prototype.readPhrase=function(){var t="";return this.tType==o.ORDER?(t=this.phrases[this.phraseIndex],this.phraseIndex++,this.phraseIndex>=this.phrases.length&&(this.phraseIndex=0)):this.tType==o.RANDOM&&(t=this.phrases[Math.round(Math.random()*(this.phrases.length-1))]),t},e.prototype.setTalkType=function(t){this.tType=t},e.prototype.setPhraseIndex=function(t){this.phraseIndex=t},e.prototype.getTalkType=function(){return this.tType},e.prototype.getPhraseIndex=function(){return this.phraseIndex},e.prototype.changeStrategy=function(t){this.strategy=t},e.prototype.changeName=function(t){this.name=t},e.prototype.getName=function(){return this.name},e.prototype.getHP=function(){return 0},e.prototype.hit=function(t){},e.prototype.hitEntity=function(t){},e.prototype.getHit=function(t){},e.prototype.clone=function(){var t=new e;return t.strategy=this.strategy.clone(t),t.sprite=this.sprite,t.prevDir=this.prevDir,t.name=this.name,t.phrases=this.phrases,t.phraseCount=this.phraseCount,t.tType=this.tType,t},e}(p),d=function(){function t(){this.target=null,this.isOpened=!1,this.text=""}return t.prototype.setTarget=function(t){this.target=t,this.isOpened=!0,this.text=t.readPhrase()},t.prototype.getTarget=function(){return this.target},t.prototype.opened=function(){return this.isOpened},t.prototype.close=function(){this.isOpened=!1,this.target=null,this.text=""},t.prototype.getText=function(){return this.text},t.prototype.next=function(){this.text=this.target.readPhrase()},t.prototype.shouldProceed=function(){return this.target.getTalkType()==o.ORDER&&0!=this.target.getPhraseIndex()},t}();!function(t){t[t.hitEvent=0]="hitEvent",t[t.castEvent=1]="castEvent",t[t.getHitEvent=2]="getHitEvent",t[t.deadEvent=3]="deadEvent",t[t.breakEvent=4]="breakEvent",t[t.noChargesEvent=5]="noChargesEvent",t[t.restEvent=6]="restEvent",t[t.drinkEvent=7]="drinkEvent",t[t.dropEvent=8]="dropEvent",t[t.pickUpEvent=9]="pickUpEvent",t[t.findEvent=10]="findEvent",t[t.finishEvent=11]="finishEvent",t[t.goalsNotMet=12]="goalsNotMet",t[t.notEnoughMoney=13]="notEnoughMoney",t[t.missingKeyItem=14]="missingKeyItem"}(l||(l={})),function(t){t[t.PLAYER=0]="PLAYER",t[t.ENEMY=1]="ENEMY",t[t.ITEM=2]="ITEM"}(y||(y={}));var f,g,x,v=function(){function t(t,e,n,o,i,s){void 0===n&&(n="you"),void 0===o&&(o="you"),void 0===i&&(i=0),void 0===s&&(s=0),this.source=t,this.type=e,this.subject=n,this.object=o,this.numValue=i,this.hp=s}return t.prototype.getSource=function(){return this.source},t.prototype.toString=function(){var t;switch(this.type){case l.hitEvent:t="".concat(this.subject," hit ").concat(this.object," with ").concat(this.numValue," damage");break;case l.castEvent:t="".concat(this.subject," casted a spell on ").concat(this.object," dealing ").concat(this.numValue," damage");break;case l.getHitEvent:t="".concat(this.subject," (").concat(this.hp,") recieved ").concat(this.numValue," damage");break;case l.deadEvent:t="".concat(this.subject," was slayed");break;case l.breakEvent:t="your ".concat(this.subject," is broken");break;case l.noChargesEvent:t="your ".concat(this.subject," has no charges left");break;case l.restEvent:t="you rested and restored ".concat(this.numValue," HP and SP");break;case l.drinkEvent:t="you drank ".concat(this.subject," and restored ").concat(this.numValue," ").concat(this.object);break;case l.dropEvent:t="you dropped your ".concat(this.subject);break;case l.pickUpEvent:t="you picked up ".concat(this.subject);break;case l.findEvent:t="you found ".concat(this.subject);break;case l.finishEvent:t="you reached the finish";break;case l.goalsNotMet:t="you need to complete the goals";break;case l.notEnoughMoney:t="you don't have enough money. You need ".concat(this.numValue);break;case l.missingKeyItem:t="you need ".concat(this.subject," to proceed");break;default:return" "}return t.charAt(0).toUpperCase()+t.slice(1)},t}();!function(t){t[t.START=0]="START",t[t.FINISH=1]="FINISH"}(f||(f={})),function(t){t[t.ENTITY=0]="ENTITY",t[t.ITEM=1]="ITEM"}(g||(g={})),function(t){t[t.HP=0]="HP",t[t.MHP=1]="MHP",t[t.MP=2]="MP",t[t.MMP=3]="MMP",t[t.SP=4]="SP",t[t.MSP=5]="MSP",t[t.DEF=6]="DEF",t[t.DAM=7]="DAM",t[t.MONEY=8]="MONEY",t[t.COST=9]="COST",t[t.DUR=10]="DUR",t[t.PRICE=11]="PRICE",t[t.COUNT=12]="COUNT",t[t.KILL=13]="KILL"}(x||(x={}));var E,S=function(){function t(t,e,n,o,i){this._type=t,this._target=e,this._name=n,this._condition=o,this._value=i}return t.prototype.type=function(){return this._type},t.prototype.target=function(){return this._target},t.prototype.name=function(){return this._name},t.prototype.condition=function(){return this._condition},t.prototype.value=function(){return this._value},t}(),P=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),I=function(t){function e(e,n,o,i){void 0===e&&(e=1),void 0===n&&(n=1),void 0===o&&(o=1),void 0===i&&(i=0);var s=t.call(this)||this;return s.reward=0,s.health=e,s.maxHealth=e,s.armor=n,s.damage=o,s.reward=i,s.name="",s}return P(e,t),e.prototype.act=function(){var t;null===(t=this.strategy)||void 0===t||t.execute()},e.prototype.changeStat=function(t,e){switch(t){case x.HP:this.health=e,this.health>this.maxHealth&&(this.health=this.maxHealth);break;case x.MHP:this.maxHealth=e;break;case x.DEF:this.armor=e;break;case x.DAM:this.damage=e;break;case x.MONEY:this.reward=e}},e.prototype.move=function(t){var e=s(this.pos,t);this.movePos(e)},e.prototype.movePos=function(t){var e=pt.getInstance().getField();e.isInField(t)&&e.cellAt(t).isFree()&&(e.cellAt(this.pos).setEntity(null),e.cellAt(t).setEntity(this),this.prevDir=r(this.pos,t),this.pos=t)},e.prototype.hit=function(t){var e=pt.getInstance().getField(),n=s(this.pos,t);e.isInField(n)&&!e.cellAt(n).isFree()&&e.cellAt(n).isAccessible()&&this.hitEntity(e.cellAt(n).getEntity())},e.prototype.hitEntity=function(t){pt.getInstance().pushEvent(new v(y.ENEMY,l.hitEvent,this.name,t.getName(),this.damage)),this.prevDir=r(this.pos,t.getPos()),t.getHit(this.damage)},e.prototype.getHit=function(t){var e=t-(this.armor?Math.floor(t/this.armor--):0);this.health-=e,pt.getInstance().pushEvent(new v(y.ENEMY,l.getHitEvent,this.name,"",e,this.health)),this.health<=0&&(pt.getInstance().getField().cellAt(this.pos).setEntity(null),pt.getInstance().removeEntity(this),pt.getInstance().pushEvent(new v(y.ENEMY,l.deadEvent,this.name)),pt.getInstance().getPlayer().addMoney(this.reward))},e.prototype.changeStrategy=function(t){this.strategy=t},e.prototype.changeName=function(t){this.name=t},e.prototype.getName=function(){return this.name},e.prototype.getHP=function(){return this.health},e.prototype.getmaxHP=function(){return this.maxHealth},e.prototype.getReward=function(){return this.reward},e.prototype.clone=function(){var t=new e(this.maxHealth,this.armor,this.damage,this.reward);return t.strategy=this.strategy.clone(t),t.sprite=this.sprite,t.prevDir=this.prevDir,t.name=this.name,t},e}(p),w=function(t){void 0===t&&(t=!1),pt.getInstance().getRules().forEach((function(e){e.target()==g.ENTITY?("player"!=e.name()&&"all"!=e.name()||(!t||e.condition()!=x.HP&&e.condition()!=x.MP&&e.condition()!=x.SP)&&pt.getInstance().getPlayer().changeStat(e.condition(),e.value()),pt.getInstance().getEntities().forEach((function(n){e.name()!=n.getName()&&"all"!=e.name()||t&&e.condition()==x.HP||n.changeStat(e.condition(),e.value())}))):e.target()==g.ITEM&&pt.getInstance().getItems().forEach((function(n){e.name()!=n.getName()&&"all"!=e.name()||t&&e.condition()==x.DUR||n.changeStat(e.condition(),e.value())}))}))},A=function(){return pt.getInstance().getRules(!1).every((function(t){var e=!0,n=0;return t.target()==g.ENTITY?pt.getInstance().getEntities().forEach((function(o){o instanceof I&&(t.name()==o.getName()||"all"==t.name())&&(t.condition()==x.COUNT?n++:t.condition()==x.KILL&&(e=!1))})):(t.target(),g.ITEM),t.condition()==x.COUNT&&n>t.value()&&(e=!1),e}))},b=function(t){var e,n,o,i,s;e="start"==t[0]?f.START:f.FINISH,"entity"==t[1]?n=g.ENTITY:"item"==t[1]&&(n=g.ITEM),o=t[2],"hp"==t[3]?i=x.HP:"mhp"==t[3]?i=x.MHP:"mp"==t[3]?i=x.MP:"mmp"==t[3]?i=x.MMP:"sp"==t[3]?i=x.SP:"msp"==t[3]?i=x.MSP:"def"==t[3]?i=x.DEF:"dam"==t[3]?i=x.DAM:"money"==t[3]?i=x.MONEY:"cost"==t[3]?i=x.COST:"dur"==t[3]?i=x.DUR:"price"==t[3]?i=x.PRICE:"kill"==t[3]?i=x.KILL:"count"==t[3]&&(i=x.COUNT),s=+t[4],pt.getInstance().addRule(new S(e,n,o,i,s),e==f.START)},M=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),C=function(t){function e(e,n,o){void 0===e&&(e=1),void 0===n&&(n=1),void 0===o&&(o=10);var i=t.call(this)||this;return i.moneyCost=0,i.damage=e,i.cost=n,i.durability=o,i.name="Weapon",i}return M(e,t),e.prototype.getName=function(){return this.name},e.prototype.getDamage=function(){return this.damage},e.prototype.getCost=function(){return this.cost},e.prototype.changeStat=function(t,e){switch(t){case x.DAM:this.damage=e;break;case x.COST:this.cost=e;break;case x.DUR:this.durability=e;break;case x.PRICE:this.moneyCost=e}},e.prototype.getDur=function(){return this.durability},e.prototype.setDur=function(t){this.durability=t},e.prototype.setMoneyCost=function(t){this.moneyCost=t},e.prototype.getMoneyCost=function(){return this.moneyCost},e.prototype.decreaseDur=function(){this.durability--,this.durability<=0&&(pt.getInstance().pushEvent(new v(y.ITEM,l.breakEvent,this.name)),pt.getInstance().getPlayer().setWeapon(null),pt.getInstance().removeItem(this))},e.prototype.changeName=function(t){this.name=t},e.prototype.clone=function(){var t=new e(this.damage,this.cost,this.durability);return t.name=this.name,t.sprite=this.sprite,t.spriteWhenUsed=this.spriteWhenUsed,t.moneyCost=this.moneyCost,t},e}(p),k=function(t){function e(e,n,o){void 0===e&&(e=1),void 0===n&&(n=1),void 0===o&&(o=1);var i=t.call(this)||this;return i.moneyCost=0,i.damage=e,i.cost=n,i.charges=o,i.name="Spell",i}return M(e,t),e.prototype.getName=function(){return this.name},e.prototype.getDamage=function(){return this.damage},e.prototype.getCost=function(){return this.cost},e.prototype.changeStat=function(t,e){switch(t){case x.DAM:this.damage=e;break;case x.COST:this.cost=e;break;case x.DUR:this.charges=e;break;case x.PRICE:this.moneyCost=e}},e.prototype.getDur=function(){return this.charges},e.prototype.setDur=function(t){this.charges=t},e.prototype.setMoneyCost=function(t){this.moneyCost=t},e.prototype.getMoneyCost=function(){return this.moneyCost},e.prototype.decreaseDur=function(){this.charges--,this.charges<=0&&(pt.getInstance().pushEvent(new v(y.ITEM,l.noChargesEvent,this.name)),pt.getInstance().getPlayer().setSpell(null),pt.getInstance().removeItem(this))},e.prototype.changeName=function(t){this.name=t},e.prototype.clone=function(){var t=new e(this.damage,this.cost,this.charges);return t.name=this.name,t.sprite=this.sprite,t.spriteWhenUsed=this.spriteWhenUsed,t.moneyCost=this.moneyCost,t},e}(p),R=function(t){function e(e,n){void 0===e&&(e=1),void 0===n&&(n=10);var o=t.call(this)||this;return o.moneyCost=0,o.armor=e,o.durability=n,o.name="Armor",o}return M(e,t),e.prototype.getName=function(){return this.name},e.prototype.getArmor=function(){return this.armor},e.prototype.changeStat=function(t,e){switch(t){case x.DEF:this.armor=e;break;case x.DUR:this.durability=e;break;case x.PRICE:this.moneyCost=e}},e.prototype.getDur=function(){return this.durability},e.prototype.setDur=function(t){this.durability=t},e.prototype.setMoneyCost=function(t){this.moneyCost=t},e.prototype.getMoneyCost=function(){return this.moneyCost},e.prototype.decreaseDur=function(){this.durability--,this.durability<=0&&(pt.getInstance().pushEvent(new v(y.ITEM,l.breakEvent,this.name)),pt.getInstance().getPlayer().setArmor(null),pt.getInstance().removeItem(this))},e.prototype.changeName=function(t){this.name=t},e.prototype.clone=function(){var t=new e(this.armor,this.durability);return t.name=this.name,t.sprite=this.sprite,t.spriteWhenUsed=this.spriteWhenUsed,t.moneyCost=this.moneyCost,t},e}(p);!function(t){t[t.HP=0]="HP",t[t.SP=1]="SP",t[t.MP=2]="MP"}(E||(E={}));var T,D=function(t){function e(e,n){void 0===e&&(e=E.HP),void 0===n&&(n=50);var o=t.call(this)||this;return o.moneyCost=0,o.type=e,o.amount=n,o.name="Potion",o}return M(e,t),e.prototype.getName=function(){return this.name},e.prototype.getType=function(){return this.type},e.prototype.getAmount=function(){return this.amount},e.prototype.changeStat=function(t,e){switch(t){case x.HP:this.type=E.HP,this.amount=e;break;case x.MP:this.type=E.MP,this.amount=e;break;case x.SP:this.type=E.SP,this.amount=e;break;case x.PRICE:this.moneyCost=e}},e.prototype.getDur=function(){return 1},e.prototype.setDur=function(t){},e.prototype.setMoneyCost=function(t){this.moneyCost=t},e.prototype.getMoneyCost=function(){return this.moneyCost},e.prototype.decreaseDur=function(){pt.getInstance().getPlayer().setPotion(null),pt.getInstance().removeItem(this)},e.prototype.changeName=function(t){this.name=t},e.prototype.clone=function(){var t=new e(this.type,this.amount);return t.name=this.name,t.sprite=this.sprite,t.spriteWhenUsed=this.spriteWhenUsed,t.moneyCost=this.moneyCost,t},e}(p),N=function(t){function e(){var e=t.call(this)||this;return e.name="KeyItem",e.moneyCost=0,e}return M(e,t),e.prototype.changeName=function(t){this.name=t},e.prototype.getName=function(){return this.name},e.prototype.setMoneyCost=function(t){this.moneyCost=t},e.prototype.getMoneyCost=function(){return this.moneyCost},e.prototype.clone=function(){var t=new e;return t.name=this.name,t.moneyCost=this.moneyCost,t.sprite=this.sprite,t},e.prototype.changeStat=function(t,e){},e.prototype.decreaseDur=function(){},e.prototype.setDur=function(t){},e.prototype.getDur=function(){return 0},e}(p),O=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),_=function(t){function e(e,n,o,i){void 0===e&&(e=1e3),void 0===n&&(n=100),void 0===o&&(o=100),void 0===i&&(i=50);var s=t.call(this)||this;return s.weapon=null,s.armor=null,s.spell=null,s.potion=null,s.maxHealth=e,s.health=e,s.maxStamina=o,s.stamina=o,s.maxMana=n,s.mana=n,s.damage=i,s.money=0,s.keyItems=[],s.name="you",s}return O(e,t),e.prototype.changeStat=function(t,e){switch(t){case x.HP:this.health=e;break;case x.MHP:this.maxHealth=e;break;case x.MP:this.mana=e;break;case x.MMP:this.maxMana=e;break;case x.SP:this.stamina=e;break;case x.MSP:this.maxStamina=e;break;case x.DAM:this.damage=e;break;case x.MONEY:this.money=e}},e.prototype.move=function(t){var e=s(this.pos,t);this.movePos(e)},e.prototype.movePos=function(t){var e,n=pt.getInstance().getField();if(n.isInField(t)){if(n.cellAt(t).isFree())n.cellAt(this.pos).setEntity(null),n.cellAt(t).setEntity(this);else{if(!(n.cellAt(t).getEntity()instanceof m))return;var o=n.cellAt(t).getEntity();o.setPos(this.pos),n.cellAt(this.pos).setEntity(o),n.cellAt(t).setEntity(this)}if(this.prevDir=r(this.pos,t),this.pos=t,pt.getInstance().playerActed(),n.cellAt(this.pos).isFinish()){var s=n.cellAt(this.pos).getTransition();!s||s.followRules&&!A()||s.key&&!this.keyItems.includes(s.key)?s&&s.key&&!this.keyItems.includes(s.key)?pt.getInstance().pushEvent(new v(y.PLAYER,l.missingKeyItem,s.key)):A()?(pt.getInstance().pushEvent(new v(y.PLAYER,l.finishEvent)),pt.getInstance().endGame()):pt.getInstance().pushEvent(new v(y.PLAYER,l.goalsNotMet)):pt.getInstance().loadMap(s.map,new i(s.x,s.y))}else n.cellAt(t).hasItem()&&pt.getInstance().pushEvent(new v(y.PLAYER,l.findEvent,null===(e=n.cellAt(t).getItem())||void 0===e?void 0:e.getName()))}},e.prototype.hit=function(t){var e=pt.getInstance().getField(),n=s(this.pos,t);if(e.isInField(n)&&!e.cellAt(n).isFree()&&e.cellAt(n).isAccessible()){var o=e.cellAt(n).getEntity();this.hitEntity(o)}},e.prototype.hitEntity=function(t){if(t instanceof m)this.talk(t);else{var e=this.damage+(this.weapon?this.weapon.getDamage():0),n=1+(this.weapon?this.weapon.getCost():0);this.stamina>=n&&(this.stamina-=n,this.prevDir=r(this.pos,t.getPos()),pt.getInstance().playerActed(),pt.getInstance().pushEvent(new v(y.PLAYER,l.hitEvent,this.name,t.getName(),e)),this.weapon&&this.weapon.decreaseDur(),t.getHit(e))}},e.prototype.castSpell=function(t){var e=pt.getInstance().getField(),n=this.spell?this.spell.getDamage():0,o=this.spell?this.spell.getCost():0,i=s(this.pos,t);if(e.isInField(i)&&!e.cellAt(i).isFree()&&e.cellAt(i).isAccessible()){var r=e.cellAt(i).getEntity();if(r instanceof m)return void this.talk(r);this.mana>=o&&this.spell&&(this.mana-=o,this.prevDir=t,pt.getInstance().playerActed(),pt.getInstance().pushEvent(new v(y.PLAYER,l.castEvent,this.name,r.getName(),n)),this.spell.decreaseDur(),r.getHit(n))}},e.prototype.talk=function(t){pt.getInstance().getDialogue().setTarget(t)},e.prototype.drinkPotion=function(){if(this.hasPotion()){var t=this.potion.getAmount(),e=this.potion.getType(),n="";e==E.HP?(this.health=this.health+t>=this.maxHealth?this.maxHealth:this.health+t,n="HP"):e==E.SP?(this.stamina=this.stamina+t>=this.maxStamina?this.maxStamina:this.stamina+t,n="SP"):e==E.MP&&(this.mana=this.mana+t>=this.maxMana?this.maxMana:this.mana+t,n="MP"),pt.getInstance().playerActed(),pt.getInstance().pushEvent(new v(y.PLAYER,l.drinkEvent,this.potion.getName(),n,t)),this.potion.decreaseDur()}},e.prototype.getHit=function(t){var e=t-(this.armor?Math.round(t/this.armor.getArmor()):0);this.health-=e,this.armor&&this.armor.decreaseDur(),pt.getInstance().pushEvent(new v(y.PLAYER,l.getHitEvent,this.name,"",e,this.health)),this.health<=0&&(pt.getInstance().getField().cellAt(this.pos).setEntity(null),pt.getInstance().pushEvent(new v(y.PLAYER,l.deadEvent,this.name)),pt.getInstance().endGame())},e.prototype.sleep=function(){this.health+=10,this.health>=this.maxHealth&&(this.health=this.maxHealth),this.stamina+=10,this.stamina>=this.maxStamina&&(this.stamina=this.maxStamina),this.mana+=10,this.mana>=this.maxMana&&(this.mana=this.maxMana),pt.getInstance().playerActed(),pt.getInstance().pushEvent(new v(y.PLAYER,l.restEvent,"","",10))},e.prototype.pickUp=function(){var t=pt.getInstance().getField();if(t.cellAt(this.pos).hasItem()){var e=t.cellAt(this.pos).getItem();if(e.getMoneyCost()>this.money)return pt.getInstance().playerActed(),void pt.getInstance().pushEvent(new v(y.PLAYER,l.notEnoughMoney,"","",e.getMoneyCost()));this.money-=e.getMoneyCost(),e.setMoneyCost(0),t.cellAt(this.pos).setItem(null),pt.getInstance().removeItem(e),e instanceof C?(this.weapon&&this.dropWeapon(),this.weapon=e):e instanceof k?(this.spell&&this.dropSpell(),this.spell=e):e instanceof R?(this.armor&&this.dropArmor(),this.armor=e):e instanceof D?(this.potion&&this.dropPotion(),this.potion=e):e instanceof N&&(this.keyItems.push(e.getName()),pt.getInstance().removeDuplicateKeyItems(e.getName())),pt.getInstance().playerActed(),pt.getInstance().pushEvent(new v(y.PLAYER,l.pickUpEvent,e.getName()))}},e.prototype.dropWeapon=function(){var t=pt.getInstance().getField();!t.cellAt(this.pos).hasItem()&&this.weapon&&(t.cellAt(this.pos).setItem(this.weapon),this.weapon.setPos(this.pos),pt.getInstance().addItem(this.weapon),pt.getInstance().pushEvent(new v(y.PLAYER,l.dropEvent,this.weapon.getName())),this.weapon=null)},e.prototype.dropSpell=function(){var t=pt.getInstance().getField();!t.cellAt(this.pos).hasItem()&&this.spell&&(t.cellAt(this.pos).setItem(this.spell),this.spell.setPos(this.pos),pt.getInstance().addItem(this.spell),pt.getInstance().pushEvent(new v(y.PLAYER,l.dropEvent,this.spell.getName())),this.spell=null)},e.prototype.dropPotion=function(){var t=pt.getInstance().getField();!t.cellAt(this.pos).hasItem()&&this.potion&&(t.cellAt(this.pos).setItem(this.potion),this.potion.setPos(this.pos),pt.getInstance().addItem(this.potion),pt.getInstance().pushEvent(new v(y.PLAYER,l.dropEvent,this.potion.getName())),this.potion=null)},e.prototype.dropArmor=function(){var t=pt.getInstance().getField();!t.cellAt(this.pos).hasItem()&&this.armor&&(t.cellAt(this.pos).setItem(this.armor),this.armor.setPos(this.pos),pt.getInstance().addItem(this.armor),pt.getInstance().pushEvent(new v(y.PLAYER,l.dropEvent,this.armor.getName())),this.armor=null)},e.prototype.getWeapon=function(){return this.weapon},e.prototype.getArmor=function(){return this.armor},e.prototype.getSpell=function(){return this.spell},e.prototype.getPotion=function(){return this.potion},e.prototype.getKeyItems=function(){return this.keyItems},e.prototype.getName=function(){return this.name},e.prototype.getHP=function(){return this.health},e.prototype.getSP=function(){return this.stamina},e.prototype.getMP=function(){return this.mana},e.prototype.setWeapon=function(t){this.weapon=t},e.prototype.setSpell=function(t){this.spell=t},e.prototype.setArmor=function(t){this.armor=t},e.prototype.setPotion=function(t){this.potion=t},e.prototype.setKeyItems=function(t){this.keyItems=t},e.prototype.hasWeapon=function(){return null!=this.weapon},e.prototype.hasSpell=function(){return null!=this.spell},e.prototype.hasArmor=function(){return null!=this.armor},e.prototype.hasPotion=function(){return null!=this.potion},e.prototype.hasKeyItems=function(){return 0!=this.keyItems.length},e.prototype.getMoney=function(){return this.money},e.prototype.addMoney=function(t){this.money+=t},e.prototype.act=function(){},e.prototype.clone=function(){var t=new e(1e3,100,100,50);return t.sprite=this.sprite,t},e}(p),L=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();!function(t){t[t.normal=0]="normal",t[t.start=1]="start",t[t.finish=2]="finish"}(T||(T={}));var H=function(t){function e(e,n,o,i){void 0===e&&(e=T.normal),void 0===n&&(n=!0),void 0===o&&(o=null),void 0===i&&(i=null);var s=t.call(this)||this;return s.accessible=n,s.state=e,s.entity=o,s.item=i,s}return L(e,t),e.prototype.getState=function(){return this.state},e.prototype.getItem=function(){return this.item},e.prototype.getEntity=function(){return this.entity},e.prototype.getTransition=function(){return this.transition||null},e.prototype.hasItem=function(){return!!this.item&&this.isAccessible()},e.prototype.isFree=function(){return!this.entity&&this.isAccessible()},e.prototype.isEntityPlayer=function(){return this.entity instanceof _},e.prototype.isEntityEnemy=function(){return this.entity instanceof I},e.prototype.isEntityNPC=function(){return this.entity instanceof m},e.prototype.isStart=function(){return this.state==T.start},e.prototype.isFinish=function(){return this.state==T.finish},e.prototype.isAccessible=function(){return this.accessible},e.prototype.setEntity=function(t){this.entity=t},e.prototype.setItem=function(t){this.item=t},e.prototype.setState=function(t){this.state=t},e.prototype.toggleAccessibility=function(){this.accessible=!this.accessible},e.prototype.setTransition=function(t){this.transition=t},e}(e),F=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.width=t,this.height=e,this.cells=Array.from(Array(t),(function(){return new Array(e)}));for(var n=0;n<t;n++)for(var o=0;o<e;o++)this.cells[n][o]=new H}return t.prototype.cellAt=function(t){var e=t instanceof i?t:new i(t.x,t.y);if(!this.isInField(e))throw new Error("Not in a field");return this.cells[t.x][t.y]},t.prototype.getWidth=function(){return this.width},t.prototype.getHeigth=function(){return this.height},t.prototype.isInField=function(t){return t.x>=0&&t.x<this.width&&t.y>=0&&t.y<this.height},t.prototype.log=function(){for(var t="",e=0;e<this.height;e++){for(var n=0;n<this.width;n++)this.cells[n][e].isAccessible()||this.cells[n][e].isFinish()?this.cells[n][e].isEntityPlayer()?t+="p ":this.cells[n][e].isEntityEnemy()?t+="e ":this.cells[n][e].isAccessible()?this.cells[n][e].isStart()?t+="s ":this.cells[n][e].isFinish()?t+="f ":this.cells[n][e].hasItem()?t+="i ":t+="  ":t+="b ":t+="x ";t+="\n"}console.log(t)},t.prototype.removeEntity=function(t){for(var e=0;e<this.width;e++)for(var n=0;n<this.height;n++)this.cells[e][n].getEntity()==t&&this.cells[e][n].setEntity(null)},t.prototype.removeItem=function(t){for(var e=0;e<this.width;e++)for(var n=0;n<this.height;n++)this.cells[e][n].getItem()==t&&this.cells[e][n].setItem(null)},t}();const K=JSON.parse('[{"name":"map1","width":28,"height":10,"enemiesCount":3,"enemies":["Zombie","Zombie","Zombie"],"npcCount":2,"npcs":["Merchant","Guide"],"itemsCount":5,"items":["Club","Katana","Iron_Armor","Fire_Spell","Healing_Potion"],"transitions":[{"map":"map3","x":1,"y":5,"followRules":false,"key":null},{"map":"map2","x":1,"y":4,"followRules":false,"key":null},{"map":"map2","x":19,"y":4,"followRules":false,"key":"Key"}],"layout":["x x x x x x x x x x x x x x x x x x x x x x x x x x x x","x o o o o o e o o o x x x i o o o o o x i o i o i o i x","x e o o o o o o o o o o o o o o o o o o o o o o n o o x","x o o o o o o o o o o o o o o o o o o x o o o o o o o x","x o o o o o o o o o x x x o o o x x x x x x x x x x x x","x o x o x o x o x o x x x o o o x x x x x x x f x x x x","x o o o o o o o o o x x x o s o o o x o o o o o o x x x","x o f o o o o o f o x x x o o o x o x o x x o o o x x x","x o o o o o o e o o x x x o n o x o o o x x x x x x x x","x x x x x x x x x x x x x x x x x x x x x x x x x x x x"],"tilesheet":"dungeon0","spritesCount":15,"sprites":[{"x":0,"y":0},{"x":1,"y":0},{"x":2,"y":0},{"x":3,"y":0},{"x":4,"y":0},{"x":0,"y":1},{"x":1,"y":1},{"x":2,"y":1},{"x":3,"y":1},{"x":4,"y":1},{"x":0,"y":2},{"x":1,"y":2},{"x":2,"y":2},{"x":3,"y":2},{"x":4,"y":2}],"spritesLayout":["4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4","4 0 0 0 0 0 0 0 0 0 4 4 4 0 1 2 2 3 0 4 0 0 0 0 0 0 0 4","4 2 3 0 0 0 0 0 0 0 0 0 0 0 6 7 7 8 0 0 0 0 0 0 0 0 0 4","4 7 8 0 0 0 0 0 0 0 0 0 0 0 11 12 12 13 0 4 0 0 0 0 0 0 0 4","4 7 8 0 0 0 0 0 0 0 4 4 4 0 0 0 4 4 4 4 4 4 4 4 4 4 4 4","4 7 14 3 14 0 14 0 14 0 4 4 4 0 0 0 4 4 4 4 4 4 4 9 4 4 4 4","4 7 7 8 0 0 0 0 0 0 4 4 4 0 0 0 0 0 4 0 0 0 0 0 0 4 4 4","4 7 10 8 0 0 0 0 5 0 4 4 4 0 0 0 4 0 4 0 4 4 0 0 0 4 4 4","4 7 7 8 0 0 0 0 0 0 4 4 4 0 0 0 4 0 0 0 4 4 4 4 4 4 4 4","4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4"],"startRulesCount":0,"finishRulesCount":0,"startRules":[],"finishRules":[]},{"name":"map2","width":21,"height":9,"enemiesCount":6,"enemies":["Ghost","Ghost","Hell-Hound","Hell-Hound","Ghost","Ghost"],"npcCount":0,"npcs":[],"itemsCount":5,"items":["Iron_Sword","Water_Spell","Key","Iron_Sword","Water_Spell"],"transitions":[{"map":"map1","x":2,"y":7,"followRules":true,"key":null},{"map":"map1","x":8,"y":7,"followRules":true,"key":"Key"}],"layout":["x x x x x x x x x x x x x x x x x x x x x","x x x x x x x x x x x x x x x x x x x x x","x i i o o o e o o o o o o o e o o o o o x","x o o o o o o x x x o x x x o o o o o o x","x f o o o o o x e o i o e x o o o o o f x","x o o o o o o x x x x x x x o o o o o o x","x i i o o o e o o o o o o o e o o o o o x","x x x x x x x x x x x x x x x x x x x x x","x x x x x x x x x x x x x x x x x x x x x"],"tilesheet":"dungeon1","spritesCount":15,"sprites":[{"x":0,"y":0},{"x":1,"y":0},{"x":2,"y":0},{"x":3,"y":0},{"x":4,"y":0},{"x":0,"y":1},{"x":1,"y":1},{"x":2,"y":1},{"x":3,"y":1},{"x":4,"y":1},{"x":0,"y":2},{"x":1,"y":2},{"x":2,"y":2},{"x":3,"y":2},{"x":4,"y":2}],"spritesLayout":["4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4","4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4","4 2 2 3 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 4","4 7 7 8 0 0 0 4 14 4 0 4 14 4 0 0 0 0 0 0 4","4 10 7 8 0 0 0 4 0 0 0 0 0 4 0 0 0 0 0 5 4","4 7 7 8 0 0 0 4 14 4 4 4 14 4 0 0 0 0 0 0 4","4 12 12 13 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 4","4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4","4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4"],"startRulesCount":0,"finishRulesCount":0,"startRules":[],"finishRules":[]},{"name":"map3","width":14,"height":9,"enemiesCount":5,"enemies":["Ghost","Zombie","Hell-Hound","Zombie","Knight"],"npcCount":0,"npcs":[],"itemsCount":2,"items":["Stamina_Potion","Mana_Potion"],"transitions":[{"map":"map4","x":7,"y":2,"followRules":true,"key":"Golden_Key"},{"map":"map1","x":23,"y":5,"followRules":false,"key":null},{"map":"map4","x":6,"y":6,"followRules":false,"key":null}],"layout":["x x x x x x x x x x x x x x","x o e o o x x f x x x x x x","x o o o e o o o o o e o x x","x o o o o x o o o x x o x x","x x x o x x x x x x x e x x","x f x o x o o o o o o o x x","x o o o x o f o e o o o x x","x o i i x o o o o o o o x x","x x x x x x x x x x x x x x"],"tilesheet":"dungeon0","spritesCount":15,"sprites":[{"x":0,"y":0},{"x":1,"y":0},{"x":2,"y":0},{"x":3,"y":0},{"x":4,"y":0},{"x":0,"y":1},{"x":1,"y":1},{"x":2,"y":1},{"x":3,"y":1},{"x":4,"y":1},{"x":0,"y":2},{"x":1,"y":2},{"x":2,"y":2},{"x":3,"y":2},{"x":4,"y":2}],"spritesLayout":["4 4 4 4 4 4 4 4 4 4 4 4 4 4","4 0 0 0 0 4 14 9 14 4 4 4 4 4","4 0 1 2 2 2 3 0 0 0 0 0 4 4","4 0 6 7 7 4 8 0 0 4 4 0 4 4","4 4 4 12 4 4 4 4 4 4 4 0 4 4","4 9 14 0 4 7 7 7 8 0 0 0 4 4","4 0 0 0 4 7 10 7 8 0 0 0 4 4","4 0 0 0 4 7 7 7 8 0 0 0 4 4","4 4 4 4 4 4 4 4 4 4 4 4 4 4"],"startRulesCount":0,"finishRulesCount":0,"startRules":[],"finishRules":[]},{"name":"map4","width":14,"height":9,"enemiesCount":3,"enemies":["Majin","Knight","Knight"],"npcCount":0,"npcs":[],"itemsCount":1,"items":["Golden_Key"],"transitions":[{"map":"map3","x":6,"y":6,"followRules":false,"key":null}],"layout":["x x x x x x x x x x x x x x","x o o o o x x x x x x x x x","x o e o o o o o o x x x x x","x o o o o x o o o x x x x x","x x x o x x x x x x x x x x","x x x o x o o o e o o o x x","x o o o x o f o o o i o x x","x o f o x o o o e o o o x x","x x x x x x x x x x x x x x"],"tilesheet":"dungeon1","spritesCount":15,"sprites":[{"x":0,"y":0},{"x":1,"y":0},{"x":2,"y":0},{"x":3,"y":0},{"x":4,"y":0},{"x":0,"y":1},{"x":1,"y":1},{"x":2,"y":1},{"x":3,"y":1},{"x":4,"y":1},{"x":0,"y":2},{"x":1,"y":2},{"x":2,"y":2},{"x":3,"y":2},{"x":4,"y":2}],"spritesLayout":["4 4 4 4 4 4 4 4 4 4 4 4 4 4","4 0 0 0 0 4 14 4 14 4 4 4 4 4","4 0 1 2 2 2 3 0 0 4 4 4 4 4","4 0 6 7 7 4 8 0 0 4 4 4 4 4","4 4 4 12 4 4 4 4 4 4 4 14 4 4","4 4 14 0 4 7 7 7 8 0 0 0 4 4","4 0 0 0 4 7 10 7 8 0 0 0 4 4","4 0 5 0 4 7 7 7 8 0 0 0 4 4","4 4 4 4 4 4 4 4 4 4 4 4 4 4"],"startRulesCount":3,"finishRulesCount":1,"startRules":["start.entity.player.hp.1000.","start.entity.player.mp.100.","start.entity.player.sp.100."],"finishRules":["finish.entity.Majin.kill.."]},{"name":"map_beta","width":14,"height":9,"enemiesCount":5,"enemies":["Zombie","Hell-Hound","Ghost","Zombie","Knight"],"npcCount":2,"npcs":["Townsman","Quester"],"itemsCount":8,"items":["Excalibur","Excalibur2","Iron_Sword","Leather_Armor","Fire_Spell","Water_Spell","Healing_Potion","Healing_Potion"],"transitions":[{"map":"map3","x":6,"y":6,"followRules":false,"key":null}],"layout":["x x x x x x x x x x x x x x","x o o o o x x x x x x x x x","x o e o o o o o e x x x x x","x e o o e x i i i x x x x x","x x x o x x x x x x x x x x","x i x n x o o o o o o o x x","x o i n x o f o e o o o x x","x i f i x o o i i o o o x x","x x x x x x x x x x x x x x"],"tilesheet":"dungeon1","spritesCount":15,"sprites":[{"x":0,"y":0},{"x":1,"y":0},{"x":2,"y":0},{"x":3,"y":0},{"x":4,"y":0},{"x":0,"y":1},{"x":1,"y":1},{"x":2,"y":1},{"x":3,"y":1},{"x":4,"y":1},{"x":0,"y":2},{"x":1,"y":2},{"x":2,"y":2},{"x":3,"y":2},{"x":4,"y":2}],"spritesLayout":["4 4 4 4 4 4 4 4 4 4 4 4 4 4","4 0 0 0 0 4 14 4 14 4 4 4 4 4","4 0 1 2 2 2 3 0 0 0 0 0 4 4","4 0 6 7 7 4 8 0 0 4 4 0 4 4","4 4 4 12 4 4 4 4 4 4 4 0 4 4","4 9 14 0 4 7 7 7 8 0 0 0 4 4","4 0 0 0 4 7 10 7 8 0 0 0 4 4","4 0 0 0 4 7 7 7 8 0 0 0 4 4","4 4 4 4 4 4 4 4 4 4 4 4 4 4"],"startRulesCount":6,"finishRulesCount":2,"startRules":["start.entity.player.mhp.500.","start.entity.player.hp.500.","start.entity.player.mmp.200.","start.entity.player.mp.200.","start.entity.Zombie.dam.1.","start.item.Iron_Sword.dam.500."],"finishRules":["finish.entity.Zombie.kill..","finish.entity.all.count.2."]}]');var W=function(t,e,n){if(n||2===arguments.length)for(var o,i=0,s=e.length;i<s;i++)!o&&i in e||(o||(o=Array.prototype.slice.call(e,0,i)),o[i]=e[i]);return t.concat(o||Array.prototype.slice.call(e))},B=function(){function t(t){void 0===t&&(t=!1),this.field=new F,this.fromSave=t}return t.prototype.setSize=function(t,e){this.field=new F(t,e)},t.prototype.toggleCellAccessibility=function(t){this.field.cellAt(t).isAccessible()&&this.field.cellAt(t).toggleAccessibility()},t.prototype.setOutsideWalls=function(){for(var t=0;t<this.field.getHeigth();t++)this.toggleCellAccessibility(new i(0,t)),this.toggleCellAccessibility(new i(this.field.getWidth()-1,t));for(t=0;t<this.field.getWidth();t++)this.toggleCellAccessibility(new i(t,0)),this.toggleCellAccessibility(new i(t,this.field.getHeigth()-1))},t.prototype.setStart=function(t){for(var e=0;e<this.field.getWidth();e++)for(var n=0;n<this.field.getHeigth();n++)this.field.cellAt(t).isStart()&&this.field.cellAt(t).setState(T.normal);this.field.cellAt(t).setState(T.start)},t.prototype.setFinish=function(t,e){this.field.cellAt(t).setState(T.finish),e&&this.field.cellAt(t).setTransition(e)},t.prototype.setEntity=function(t,e){this.field.cellAt(e).setEntity(t),t.setPos(e),this.fromSave||pt.getInstance().addEntity(t)},t.prototype.setItem=function(t,e){this.field.cellAt(e).setItem(t),t.setPos(e),this.fromSave||pt.getInstance().addItem(t)},t.prototype.canItemBeSet=function(t){return this.field.isInField(t)&&!this.field.cellAt(t).hasItem()},t.prototype.canEntityBeSet=function(t){return this.field.isInField(t)&&this.field.cellAt(t).isFree()},t.prototype.setSprite=function(t,e){this.field.cellAt(e).setSprite(t)},t.prototype.buildPresetMap=function(t,e){var n=this,o=K.find((function(e){return e.name==t}));this.setSize(o.width,o.height);var s=W([],o.enemies,!0),r=W([],o.npcs,!0),a=W([],o.items,!0),c=W([],o.transitions,!0);o.layout.forEach((function(t,o){t.split(" ").forEach((function(t,h){switch(t){case"s":n.setStart(new i(h,o));break;case"f":n.setFinish(new i(h,o),c.shift());break;case"b":n.toggleCellAccessibility(new i(h,o)),n.setFinish(new i(h,o));case"x":n.toggleCellAccessibility(new i(h,o));break;case"e":n.fromSave||n.setEntity(e.getEnemies().get(s.shift()).clone(),new i(h,o));break;case"n":n.fromSave||n.setEntity(e.getNPCs().get(r.shift()).clone(),new i(h,o));break;case"i":n.fromSave||n.setItem(e.getItems().get(a.shift()).clone(),new i(h,o))}}))}));var h=e.getTilesheets().get(o.tilesheet),p=[];o.sprites.forEach((function(t){p.push({source:h,pos:new i(t.x,t.y)})})),o.spritesLayout.forEach((function(t,e){t.split(" ").forEach((function(t,o){n.setSprite(p[+t],new i(o,e))}))})),pt.getInstance().clearRules(!0),pt.getInstance().clearRules(!1),o.startRules.forEach((function(t){return b(t.split("."))})),o.finishRules.forEach((function(t){return b(t.split("."))}))},t.prototype.getPresetMap=function(t,e){return this.buildPresetMap(t,e),this.getField()},t.prototype.getField=function(){var t=this.field;return this.reset(),t},t.prototype.reset=function(){this.field=new F},t}(),U=32,j=function(){function t(){this.animState={secondAnimFrame:!1,playerResting:!1,playerDropping:!1,playerDrinking:!1,scale:2},this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d"),this.scaledSpriteSize=this.animState.scale*U}return t.prototype.drawItem=function(t,e,n){if(this.drawSprite(t.getSprite(),e,n),t.getMoneyCost()){var o="".concat(t.getMoneyCost(),"$");this.ctx.font="".concat(Math.floor(this.scaledSpriteSize/4),"px PixeloidSans"),this.ctx.fillStyle="white",this.ctx.fillText(o,e+2,n+this.scaledSpriteSize-2,this.scaledSpriteSize-4)}},t.prototype.drawEntity=function(t,e,n){var o=t.getSprite();if(o.pos=new i(+t.getDir()%4,+this.animState.secondAnimFrame),this.drawSprite(o,e,n),t instanceof I&&t.getHP()<t.getmaxHP()){var s=2*this.animState.scale,r=3*this.animState.scale,a=Math.ceil(this.scaledSpriteSize/16),c=this.scaledSpriteSize-2*s,h=c*t.getHP()/t.getmaxHP();this.ctx.fillStyle="green",this.ctx.fillRect(e+s,n+this.scaledSpriteSize-a-r,h,a),this.ctx.fillStyle="red",this.ctx.fillRect(e+s+h,n+this.scaledSpriteSize-a-r,c-h,a)}},t.prototype.drawPlayer=function(t,e){var n,o,s,r=pt.getInstance().getPlayer(),a=r.getSprite();this.animState.playerResting?a.pos=new i(0,2):this.animState.playerDropping?a.pos=new i(1,2):this.animState.playerDrinking?a.pos=new i(2,2):a.pos=new i(+r.getDir()%4,+this.animState.secondAnimFrame),this.drawSprite(a,t,e),r.hasArmor()&&(r.getArmor().getUSprite().pos=a.pos,this.drawSprite(null===(n=r.getArmor())||void 0===n?void 0:n.getUSprite(),t,e)),this.animState.playerResting||this.animState.playerDropping||this.animState.playerDrinking||(r.hasWeapon()&&(r.getWeapon().getUSprite().pos=a.pos,this.drawSprite(null===(o=r.getWeapon())||void 0===o?void 0:o.getUSprite(),t,e)),r.hasSpell()&&(r.getSpell().getUSprite().pos=a.pos,this.drawSprite(null===(s=r.getSpell())||void 0===s?void 0:s.getUSprite(),t,e)))},t.prototype.drawSprite=function(t,e,n){this.ctx.drawImage(t.source,t.pos.x*U,t.pos.y*U,U,U,e,n,U*this.animState.scale,U*this.animState.scale)},t.prototype.noSmoothing=function(){this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.mozImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1},t.prototype.drawField=function(t){var e,n;this.noSmoothing();for(var o=pt.getInstance().getPlayer().getPos(),s=Math.round(this.canvas.width/2-this.scaledSpriteSize*(.5+o.x)),r=Math.round(this.canvas.height/2-this.scaledSpriteSize*(.5+o.y)),a=0;a<t.getWidth();a++)for(var c=0;c<t.getHeigth();c++){e=a*this.scaledSpriteSize+s,n=c*this.scaledSpriteSize+r;var h=new i(a,c);this.drawSprite(t.cellAt(h).getSprite(),e,n),t.cellAt(h).hasItem()&&this.drawItem(t.cellAt(h).getItem(),e,n),t.cellAt(h).isEntityEnemy()||t.cellAt(h).isEntityNPC()?this.drawEntity(t.cellAt(h).getEntity(),e,n):t.cellAt(h).isEntityPlayer()&&this.drawPlayer(e,n)}},t.prototype.drawInfo=function(){var t,e,n,o,i=this;this.ctx.font="22px Pixeboy",this.ctx.fillStyle="white";var s,r=pt.getInstance().getPlayer();s="HP: ".concat(r.getHP(),"\tSP: ").concat(r.getSP(),"\tMP: ").concat(r.getMP()),this.ctx.fillText(s,10,25),s="Weapon: ".concat(r.hasWeapon()?null===(t=r.getWeapon())||void 0===t?void 0:t.getName().replace("_"," "):"None"),this.ctx.fillText(s,10,50),s="Spell: ".concat(r.hasSpell()?null===(e=r.getSpell())||void 0===e?void 0:e.getName().replace("_"," "):"None"),this.ctx.fillText(s,10,75),s="Armor: ".concat(r.hasArmor()?null===(n=r.getArmor())||void 0===n?void 0:n.getName().replace("_"," "):"None"),this.ctx.fillText(s,10,100),s="Potion: ".concat(r.hasPotion()?null===(o=r.getPotion())||void 0===o?void 0:o.getName().replace("_"," "):"None"),this.ctx.fillText(s,10,125),s="Money: ".concat(r.getMoney()),this.ctx.fillText(s,10,150);var a,c=195,h=0;(a=[],pt.getInstance().getRules(!1).forEach((function(t){var e="";switch(t.condition()){case x.COUNT:e="No more than ".concat(t.value()," ").concat("all"==t.name()?"entities":t.name(),"  on the map");break;case x.KILL:e="Kill every  ".concat("all"==t.name()?"entity":t.name(),"  on the map")}a.push(e)})),a).forEach((function(t){i.ctx.fillText(t,30,c),c+=20,h++})),s="Goals: ".concat(h?"":"None"),this.ctx.fillText(s,10,175)},t.prototype.drawLog=function(){var t=this;this.ctx.font="16px PixeloidSans",this.ctx.fillStyle="white";var e,n=25;pt.getInstance().getEvents().forEach((function(o){e=o.toString(),t.ctx.fillText(e,t.canvas.width-t.ctx.measureText(e).width-10,n),n+=20}))},t.prototype.drawDialogue=function(){var t=this,e=pt.getInstance().getDialogue();if(e.opened()){var n=Math.ceil(this.canvas.height-200),o=20,i=10;this.ctx.fillStyle="#261705",this.ctx.fillRect(0,n,this.canvas.width,o+2*i);var s=i-8,r=e.getTarget().getName();n+=8,this.ctx.font="".concat(o,"px PixeloidSans"),this.ctx.fillStyle="#b8a288",this.ctx.fillRect(40,n,this.ctx.measureText(r).width+16,o+2*s),n+=s+o-3,this.ctx.fillStyle="#140c02",this.ctx.fillText(r,50,n,this.canvas.width-16),n+=i+3,this.ctx.fillStyle="#b8a288",this.ctx.fillRect(0,n,this.canvas.width,this.canvas.height-n),i=50,n+=30,o=20,this.ctx.font="".concat(o,"px PixeloidSans"),this.ctx.fillStyle="#140c02",this.getLines(e.getText(),this.canvas.width-2*i).forEach((function(e){t.ctx.fillText(e,i,n,t.canvas.width-2*i),n+=o+4}))}},t.prototype.clear=function(){this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},t.prototype.toggleAnimFrame=function(){this.animState.secondAnimFrame=!this.animState.secondAnimFrame},t.prototype.clearPlayerAction=function(){this.animState.playerResting=!1,this.animState.playerDropping=!1,this.animState.playerDrinking=!1},t.prototype.playerRest=function(){this.animState.playerResting=!0},t.prototype.playerDrop=function(){this.animState.playerDropping=!0},t.prototype.playerDrink=function(){this.animState.playerDrinking=!0},t.prototype.getScale=function(){return this.animState.scale},t.prototype.changeScale=function(t){this.animState.scale=t<1?1:t>5?5:t,this.scaledSpriteSize=this.animState.scale*U},t.prototype.setPlayerSprite=function(){var t=new Image;t.src="assets/objects/Player.png",pt.getInstance().getPlayer().setSprite({source:t,pos:new i(0,0)})},t.prototype.addResizeListener=function(){var t=this,e=function(){t.canvas.width=window.innerWidth,t.canvas.height=window.innerHeight};e(),window.addEventListener("resize",e,!1)},t.prototype.getLines=function(t,e){for(var n=t.split(" "),o=[],i=n[0],s=1;s<n.length;s++){var r=n[s];this.ctx.measureText(i+" "+r).width<e?i+=" "+r:(o.push(i),i=r)}return o.push(i),o},t}();const Y=JSON.parse('{"UP":"KeyW","DOWN":"KeyS","LEFT":"KeyA","RIGHT":"KeyD","HIT":"KeyZ","CAST":"KeyC","SLEEP":"KeyR","BUFF":"KeyB","PICK_UP":"Space","DROP_W":"KeyU","DROP_S":"KeyI","DROP_A":"KeyO","DROP_P":"KeyP","QSAVE":"BracketLeft","QLOAD":"BracketRight"}');var G;!function(t){t.UP="UP",t.DOWN="DOWN",t.LEFT="LEFT",t.RIGHT="RIGHT",t.HIT="HIT",t.CAST="CAST",t.SLEEP="SLEEP",t.BUFF="BUFF",t.PICK_UP="PICK_UP",t.DROP_W="DROP_W",t.DROP_S="DROP_S",t.DROP_A="DROP_A",t.DROP_P="DROP_P",t.QSAVE="QSAVE",t.QLOAD="QLOAD",t.MOVE="MOVE",t.END="END"}(G||(G={}));var z=function(){function e(){var t=this;this.action=null,this.dir=null,this.controls=Y,this.pressed=new Set,this.currentlyPressed=new Set,this.actionGiven=!1,document.addEventListener("keydown",(function(e){return t.readInput(e)})),document.addEventListener("keyup",(function(e){return t.readInput(e,!1)})),document.onwheel=function(e){return t.readInput(e)}}return e.prototype.isKeyPressed=function(t){return this.pressed.has(this.controls[t])},e.prototype.processInput=function(){var e=pt.getInstance().getMenu(),n=pt.getInstance().getDialogue();if(e.opened())this.pressed.has("Escape")?e.processEscape():this.pressed.has("Enter")?this.click(e.getFocusedButton()):this.pressed.has("ArrowUp")||this.pressed.has("ArrowLeft")?e.prevButton():(this.pressed.has("ArrowDown")||this.pressed.has("ArrowRight"))&&e.nextButton();else if(n.opened())this.pressed.has("Escape")||!n.shouldProceed()?n.close():n.next();else{this.actionGiven=!0;var o=this.isKeyPressed(G.UP),i=this.isKeyPressed(G.RIGHT),s=this.isKeyPressed(G.DOWN),r=this.isKeyPressed(G.LEFT);this.dir=function(e,n,o,i){return e&&!o?i&&!n?t.NW:n&&!i?t.NE:t.N:o&&!e?i&&!n?t.SW:n&&!i?t.SE:t.S:i&&!n?t.W:n&&!i?t.E:null}(o,i,s,r),null!==this.dir?this.isKeyPressed(G.HIT)?this.action=G.HIT:this.isKeyPressed(G.CAST)?this.action=G.CAST:this.action=G.MOVE:this.isKeyPressed(G.SLEEP)?this.action=G.SLEEP:this.isKeyPressed(G.PICK_UP)?this.action=G.PICK_UP:this.isKeyPressed(G.BUFF)?this.action=G.BUFF:this.isKeyPressed(G.DROP_W)?this.action=G.DROP_W:this.isKeyPressed(G.DROP_S)?this.action=G.DROP_S:this.isKeyPressed(G.DROP_A)?this.action=G.DROP_A:this.isKeyPressed(G.DROP_P)?this.action=G.DROP_P:this.isKeyPressed(G.QSAVE)?this.action=G.QSAVE:this.isKeyPressed(G.QLOAD)?this.action=G.QLOAD:(this.pressed.has("Escape")&&e.toggle(),this.actionGiven=!1)}this.pressed.clear()},e.prototype.readInput=function(t,e){if(void 0===e&&(e=!0),pt.getInstance().isActive())if(t instanceof KeyboardEvent){var n=t.code;if(e){if(t.ctrlKey||t.altKey)return;this.pressed.add(n),this.currentlyPressed.add(n)}else this.currentlyPressed.delete(n),this.currentlyPressed.size||this.processInput()}else t instanceof WheelEvent&&pt.getInstance().changeScale(t.deltaY/50)},e.prototype.getAction=function(){return this.action},e.prototype.getDirection=function(){return this.dir},e.prototype.clearActions=function(){this.actionGiven=!1},e.prototype.hasAction=function(){return this.actionGiven},e.prototype.getActionControls=function(t){return this.controls[t]},e.prototype.getControlsString=function(){var t=[];return t.push("Move: ".concat(this.getActionControls(G.UP),", ").concat(this.getActionControls(G.LEFT),", ").concat(this.getActionControls(G.DOWN),", ").concat(this.getActionControls(G.RIGHT))),t.push("Hit/Talk: ".concat(this.getActionControls(G.HIT)," + move")),t.push("Cast spell: ".concat(this.getActionControls(G.CAST)," + move")),t.push("Sleep: ".concat(this.getActionControls(G.SLEEP))),t.push("Drink potion: ".concat(this.getActionControls(G.BUFF))),t.push("Pick up: ".concat(this.getActionControls(G.PICK_UP))),t.push("Drop weapon: ".concat(this.getActionControls(G.DROP_W))),t.push("Drop spell: ".concat(this.getActionControls(G.DROP_S))),t.push("Drop armor: ".concat(this.getActionControls(G.DROP_A))),t.push("Drop potion: ".concat(this.getActionControls(G.DROP_P))),t.push("Quick save: ".concat(this.getActionControls(G.QSAVE))),t.push("Quick load: ".concat(this.getActionControls(G.QLOAD))),t},e.prototype.click=function(t){var e=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});t.dispatchEvent(e)},e}(),Q=function(){function t(){}return t.prototype.save=function(t){try{var e={map:"",entityCount:0,entities:[],itemCount:0,items:[],player:{x:0,y:0,hp:0,sp:0,mp:0,money:0,weapon:{name:"",dur:0,money:0},spell:{name:"",dur:0,money:0},armor:{name:"",dur:0,money:0},potion:{name:"",dur:0,money:0},keyItems:[]}},n=pt.getInstance(),o=n.getEntities(),i=n.getItems(),s=n.getPlayer();e.map=pt.getInstance().getCurrentMap();var r,a=0;return o.forEach((function(t){a++,r=t.getPos(),e.entities.push({name:t.getName(),x:r.x,y:r.y,hp:t instanceof m?t.getPhraseIndex():t.getHP()})})),e.entityCount=a,a=0,i.forEach((function(t){a++,r=t.getPos(),e.items.push({name:t.getName(),x:r.x,y:r.y,dur:t.getDur(),money:t.getMoneyCost()})})),e.itemCount=a,r=s.getPos(),e.player={x:r.x,y:r.y,hp:s.getHP(),sp:s.getSP(),mp:s.getMP(),money:s.getMoney(),weapon:s.hasWeapon()?{name:s.getWeapon().getName(),dur:s.getWeapon().getDur(),money:s.getWeapon().getMoneyCost()}:{name:"None",dur:0,money:0},spell:s.hasSpell()?{name:s.getSpell().getName(),dur:s.getSpell().getDur(),money:s.getSpell().getMoneyCost()}:{name:"None",dur:0,money:0},armor:s.hasArmor()?{name:s.getArmor().getName(),dur:s.getArmor().getDur(),money:s.getArmor().getMoneyCost()}:{name:"None",dur:0,money:0},potion:s.hasPotion()?{name:s.getPotion().getName(),dur:s.getPotion().getDur(),money:s.getPotion().getMoneyCost()}:{name:"None",dur:0,money:0},keyItems:s.getKeyItems()},localStorage.setItem("save ".concat(t),JSON.stringify(e)),n.msg("Game saved\n"),!0}catch(t){var c;return c=t instanceof Error?t.message:String(t),pt.getInstance().msg(c),!1}},t.prototype.load=function(t){try{var e=localStorage.getItem("save ".concat(t));if(!e)throw new Error("Error: Save not found");var n=JSON.parse(e),o=pt.getInstance(),s=o.getStorage(),r=new B(!0);r.buildPresetMap(n.map,s);var a,c,h=[],p=[],u=void 0;if(n.entities.forEach((function(t){var e;if(s.checkEnemy(t.name))(e=s.getEnemies().get(t.name).clone()).changeStat(x.HP,t.hp);else{if(!s.checkNPC(t.name))throw new Error("Entity ".concat(t.name," not found"));(e=s.getNPCs().get(t.name).clone()).setPhraseIndex(t.hp)}if(c=new i(t.x,t.y),!r.canEntityBeSet(c))throw new Error("Error while placing an entity");e.setPos(c),h.push(e),r.setEntity(e,c)})),n.items.forEach((function(t){if(!s.checkItem(t.name))throw new Error("Error: Itme ".concat(t.name," not found"));var e=s.getItems().get(t.name).clone();if(e.changeStat(x.DUR,t.dur),e.changeStat(x.PRICE,t.money),c=new i(t.x,t.y),!r.canItemBeSet(c))throw new Error("Error while placing an item");e.setPos(c),p.push(e),r.setItem(e,c)})),c=new i(n.player.x,n.player.y),!r.canEntityBeSet(c))throw new Error("Error while placing a player");(u=o.getPlayer().clone()).setPos(c),u.changeStat(x.HP,n.player.hp),u.changeStat(x.MP,n.player.mp),u.changeStat(x.SP,n.player.sp),u.changeStat(x.MONEY,n.player.money),a=r.getField();var l=n.player.weapon;if("None"!=l.name){if(!s.checkItem(l.name))throw new Error("Error: Item ".concat(l.name," not found"));var y=s.getItems().get(l.name).clone();y.changeStat(x.DUR,l.dur),y.changeStat(x.PRICE,l.money),u.setWeapon(y)}if("None"!=(l=n.player.spell).name){if(!s.checkItem(l.name))throw new Error("Error: Itme ".concat(l.name," not found"));var m=s.getItems().get(l.name).clone();m.changeStat(x.DUR,l.dur),m.changeStat(x.PRICE,l.money),u.setSpell(m)}if("None"!=(l=n.player.armor).name){if(!s.checkItem(l.name))throw new Error("Error: Itme ".concat(l.name," not found"));var d=s.getItems().get(l.name).clone();d.changeStat(x.DUR,l.dur),d.changeStat(x.PRICE,l.money),u.setArmor(d)}if("None"!=(l=n.player.potion).name){if(!s.checkItem(l.name))throw new Error("Error: Itme ".concat(l.name," not found"));var f=s.getItems().get(l.name).clone();f.changeStat(x.DUR,l.dur),f.changeStat(x.PRICE,l.money),u.setPotion(f)}return u.setKeyItems(n.player.keyItems),o.setMap(n.map,a,h,p,u),o.msg("Save ".concat(t," loaded\n")),!0}catch(t){var g;return g=t instanceof Error?t.message:String(t),pt.getInstance().msg(g),!1}},t}(),V=new i(-1,-1),q=function(){function t(t){this.entity=t,this.posFromGuarding=V}return t.prototype.execute=function(){var t=this.entity.getPos();this.posFromGuarding==V&&(this.posFromGuarding=t);var e=pt.getInstance().getPlayer();if(!a(e.getPos(),t)||this.entity instanceof m){var n=s(t,c());a(n,this.posFromGuarding)&&this.entity.movePos(n)}else this.entity.hitEntity(e)},t.prototype.clone=function(e){return new t(e)},t}(),Z=function(){function t(t){this.entity=t}return t.prototype.execute=function(){if(this.entity instanceof m)this.entity.move(c());else{var t=this.entity.getPos(),e=pt.getInstance().getPlayer();if(a(e.getPos(),t))this.entity.hitEntity(e);else{var n=X(2,t,e.getPos());n?this.entity.movePos(n):this.entity.move(c())}}},t.prototype.clone=function(e){return new t(e)},t}(),J=function(){function t(t){this.entity=t}return t.prototype.execute=function(){var t=this.entity.getPos(),e=pt.getInstance().getPlayer();if(!a(e.getPos(),t)||this.entity instanceof m){var n=X(10,t,e.getPos());n?this.entity.movePos(n):this.entity.move(c())}else this.entity.hitEntity(e)},t.prototype.clone=function(e){return new t(e)},t}(),$=function(){function e(e){this.entity=e,this.dir=t.N}return e.prototype.execute=function(){var t=this.entity.getPos(),e=pt.getInstance().getPlayer();if(!a(e.getPos(),t)||this.entity instanceof m){for(var n=pt.getInstance().getField(),o=0;o<4;o++){var i=s(t,this.dir);if(!n.isInField(i)||n.cellAt(i).isFree())break;this.dir=(this.dir+1)%4}this.entity.move(this.dir)}else this.entity.hitEntity(e)},e.prototype.clone=function(t){return new e(t)},e}();function X(t,e,n){var o,i,r,a=[],c=new Map,h=pt.getInstance().getField(),p=e,u=0;for(c.set(p,V);(a.length>0||!u)&&!p.equals(n)&&u<=t;){for(var l=0;l<8;l++)r=s(p,l),h.isInField(r)&&(h.cellAt(r).isFree()||r.equals(n))&&!tt(c,r)&&(c.set(r,p),a.push(r));for(u=0,r=p=a.shift();r=c.get(r),u++,!(null===(o=c.get(r))||void 0===o?void 0:o.equals(V)););}if(!p.equals(n))return null;for(;p=c.get(p),!(null===(i=c.get(c.get(p)))||void 0===i?void 0:i.equals(V)););return p}var tt=function(t,e){return Array.from(t.keys()).some((function(t){return t.equals(e)}))};const et=JSON.parse('[{"name":"Zombie","strategy":"wander","hp":100,"def":10,"dam":1,"money":10},{"name":"Ghost","strategy":"patrol","hp":50,"def":100,"dam":50,"money":10},{"name":"Hell-Hound","strategy":"hunt","hp":100,"def":10,"dam":10,"money":10},{"name":"Knight","strategy":"guard","hp":100,"def":10,"dam":10,"money":100},{"name":"Majin","strategy":"hunt","hp":1000,"def":20,"dam":50,"money":10000}]');var nt=function(){function t(){this.enemy=new I}return t.prototype.setStrategy=function(t){this.enemy.changeStrategy(t)},t.prototype.setStats=function(t,e,n,o){void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=1),void 0===o&&(o=0),this.enemy=new I(t,e,n,o)},t.prototype.setName=function(t){this.enemy.changeName(t)},t.prototype.setSprite=function(t){this.enemy.setSprite(t)},t.prototype.buildPresetEnemy=function(t){var e=et.find((function(e){return e.name==t}));this.setStats(e.hp,e.def,e.dam,e.money),this.setName(e.name),"guard"==e.strategy?this.setStrategy(new q(this.enemy)):"wander"==e.strategy?this.setStrategy(new Z(this.enemy)):"hunt"==e.strategy?this.setStrategy(new J(this.enemy)):"patrol"==e.strategy&&this.setStrategy(new $(this.enemy));var n=new Image;n.src="assets/objects/entities/".concat(e.name,".png"),this.setSprite({source:n,pos:new i(0,0)})},t.prototype.getPresetEnemy=function(t){return this.buildPresetEnemy(t),this.getEnemy()},t.prototype.getEnemy=function(){var t=this.enemy;return this.reset(),t},t.prototype.reset=function(){this.enemy=new I},t.prototype.getEnemyList=function(){var t=[];return et.forEach((function(e){t.push(e.name)})),t},t}();const ot=JSON.parse('[{"name":"Iron_Sword","type":"weapon","dam":30,"cost":3,"dur":50,"money":0},{"name":"Katana","type":"weapon","dam":40,"cost":4,"dur":200,"money":50},{"name":"Club","type":"weapon","dam":10,"cost":3,"dur":20,"money":0},{"name":"Fire_Spell","type":"spell","dam":500,"cost":20,"charges":1,"money":100},{"name":"Water_Spell","type":"spell","dam":15,"cost":5,"charges":1,"money":0},{"name":"Leather_Armor","type":"armor","armor":10,"dur":5,"money":0},{"name":"Iron_Armor","type":"armor","armor":30,"dur":50,"money":50},{"name":"Healing_Potion","type":"potion","pType":"HP","amount":50,"money":10},{"name":"Mana_Potion","type":"potion","pType":"MP","amount":50,"money":0},{"name":"Stamina_Potion","type":"potion","pType":"SP","amount":50,"money":0},{"name":"Key","type":"key","money":0},{"name":"Golden_Key","type":"key","money":100}]');var it=function(){function t(){this.item=new C}return t.prototype.newWeapon=function(t,e,n){void 0===t&&(t=1),void 0===e&&(e=1),void 0===n&&(n=10),this.item=new C(t,e,n)},t.prototype.newSpell=function(t,e,n){void 0===t&&(t=1),void 0===e&&(e=1),void 0===n&&(n=1),this.item=new k(t,e,n)},t.prototype.newPotion=function(t,e){void 0===t&&(t=E.HP),void 0===e&&(e=50),this.item=new D(t,e)},t.prototype.newArmor=function(t,e){void 0===t&&(t=1),void 0===e&&(e=10),this.item=new R(t,e)},t.prototype.newKeyItem=function(){this.item=new N},t.prototype.setName=function(t){this.item.changeName(t)},t.prototype.setCost=function(t){this.item.setMoneyCost(t)},t.prototype.setSprite=function(t){this.item.setSprite(t)},t.prototype.setUSprite=function(t){this.item.setUSprite(t)},t.prototype.buildPresetItem=function(t){var e=ot.find((function(e){return e.name==t}));if("weapon"==e.type)this.newWeapon(e.dam,e.cost,e.dur);else if("spell"==e.type)this.newSpell(e.dam,e.cost,e.charges);else if("armor"==e.type)this.newArmor(e.armor,e.dur);else if("potion"==e.type){var n="HP"==e.pType?E.HP:"MP"==e.pType?E.MP:E.SP;this.newPotion(n,e.amount)}else"key"==e.type&&this.newKeyItem();this.setName(e.name),this.setCost(e.money);var o=new Image;o.src="assets/objects/items/".concat(e.name,".png"),this.setSprite({source:o,pos:new i(0,0)}),o=new Image,"weapon"==e.type||"spell"==e.type?(o.src="assets/objects/items/tool/".concat(e.name,".png"),this.setUSprite({source:o,pos:new i(0,0)})):"armor"==e.type&&(o.src="assets/objects/items/armor/".concat(e.name,".png"),this.setUSprite({source:o,pos:new i(0,0)}))},t.prototype.getPresetItem=function(t){return this.buildPresetItem(t),this.getItem()},t.prototype.getItem=function(){var t=this.item;return this.reset(),t},t.prototype.reset=function(){this.item=new C},t.prototype.getItemList=function(){var t=[];return ot.forEach((function(e){t.push(e.name)})),t},t}();const st=JSON.parse('[{"name":"Guide","strategy":"guard","talkType":"order","phrases":["*This is not a full game, just a test to see most of game mechanics","The evil Majin terrorize the country and you need to defeat him","To find him you need to enter the door to the right but you need a key for that door","You can find a key if you enter the trapdoor to the left","And be careful: Majin has an army of undead and possessed knights","Good luck"]},{"name":"Merchant","strategy":"guard","talkType":"random","phrases":["You need credits to buy this stuff","You can find free stuff on the ground but it won\'t be so good","Items in the shop require money but they will serve better and longer"]}]');var rt=function(){function t(){this.npc=new m}return t.prototype.setStrategy=function(t){this.npc.changeStrategy(t)},t.prototype.setTalkType=function(t){this.npc.setTalkType(t)},t.prototype.setPhrases=function(t){this.npc.setPhrases(t)},t.prototype.setName=function(t){this.npc.changeName(t)},t.prototype.setSprite=function(t){this.npc.setSprite(t)},t.prototype.buildPresetNPC=function(t){var e=st.find((function(e){return e.name==t}));this.setName(e.name),this.setPhrases(e.phrases),"order"==e.talkType?this.setTalkType(o.ORDER):"random"==e.talkType&&this.setTalkType(o.RANDOM),"guard"==e.strategy?this.setStrategy(new q(this.npc)):"wander"==e.strategy?this.setStrategy(new Z(this.npc)):"hunt"==e.strategy?this.setStrategy(new J(this.npc)):"patrol"==e.strategy&&this.setStrategy(new $(this.npc));var n=new Image;n.src="assets/objects/entities/".concat(e.name,".png"),this.setSprite({source:n,pos:new i(0,0)})},t.prototype.getPresetNPC=function(t){return this.buildPresetNPC(t),this.getNPC()},t.prototype.getNPC=function(){var t=this.npc;return this.reset(),t},t.prototype.reset=function(){this.npc=new m},t.prototype.getNPCList=function(){var t=[];return st.forEach((function(e){t.push(e.name)})),t},t}();const at=JSON.parse('["dungeon0","dungeon1","dungeon_beta"]');var ct=function(){function t(){this.tilesheets=new Map,this.enemies=new Map,this.npcs=new Map,this.items=new Map}return t.prototype.readTilesheets=function(){var t,e=this;pt.getInstance().msg("Reading tilesheets: "),at.forEach((function(n){(t=new Image).src="assets/tilesheets/".concat(n,".png"),e.tilesheets.set(n,t),pt.getInstance().msg("\t".concat(n))})),pt.getInstance().msg("\n")},t.prototype.readEnemies=function(){var t=this,e=new nt;pt.getInstance().msg("Reading enemies: "),e.getEnemyList().forEach((function(n){t.enemies.set(n,e.getPresetEnemy(n)),pt.getInstance().msg("\t".concat(n))})),pt.getInstance().msg("\n")},t.prototype.readNPCs=function(){var t=this,e=new rt;pt.getInstance().msg("Reading NPCs: "),e.getNPCList().forEach((function(n){t.npcs.set(n,e.getPresetNPC(n)),pt.getInstance().msg("\t".concat(n))})),pt.getInstance().msg("\n")},t.prototype.readItems=function(){var t=this,e=new it;pt.getInstance().msg("Reading items: "),e.getItemList().forEach((function(n){t.items.set(n,e.getPresetItem(n)),pt.getInstance().msg("\t".concat(n))})),pt.getInstance().msg("\n")},t.prototype.getTilesheets=function(){return this.tilesheets},t.prototype.getEnemies=function(){return this.enemies},t.prototype.getNPCs=function(){return this.npcs},t.prototype.getItems=function(){return this.items},t.prototype.checkTexture=function(t){return this.tilesheets.has(t)},t.prototype.checkEnemy=function(t){return this.enemies.has(t)},t.prototype.checkNPC=function(t){return this.npcs.has(t)},t.prototype.checkItem=function(t){return this.items.has(t)},t}(),ht=function(){function t(){this.menu=document.getElementById("game-menu"),this.menuOverlay=document.getElementById("menu-overlay"),this.mainOpened=!1,this.saveOpened=!1,this.controlsOpened=!1,this.chosenSave=1,this.focusedIndex=0,this.saveBtnIndex=4,this.mainMenuButtons=this.initMainMenuButtons(),this.saveMenuButtons=this.initSaveMenuButtons(),this.title=document.getElementById("game-menu-title"),this.controlsList=document.getElementById("controls-list"),this.endTitle=document.getElementById("game-result"),this.initControlsList(),this.toggle()}return t.prototype.initMainMenuButtons=function(){var t,e=this,n=[];return(t=document.createElement("button")).id="btn-start",t.innerHTML="Start",t.addEventListener("click",(function(t){pt.getInstance().setStarted(),e.toggle()})),n.push(t),(t=document.createElement("button")).id="btn-saves",t.innerHTML="Load",t.addEventListener("click",(function(t){e.saveOpened=!0,e.focusedIndex=1,e.setButtons()})),n.push(t),(t=document.createElement("button")).id="btn-controls",t.innerHTML="Controls",t.addEventListener("click",(function(t){e.controlsOpened=!0,e.focusedIndex=0,e.setButtons()})),n.push(t),n.forEach((function(t,n){t.addEventListener("mouseover",(function(t){e.setFocused(n),e.setButtons()})),e.menu.appendChild(t),t.hidden=!0})),n},t.prototype.initSaveMenuButtons=function(){for(var t,e=this,n=[],o=function(o){(t=document.createElement("button")).id="btn-save-".concat(o),t.innerHTML="".concat(o?"":"Quick","Save ").concat(o||""),t.addEventListener("click",(function(t){e.chosenSave=o,e.setButtons()})),n.push(t)},i=0;i<4;i++)o(i);return(t=document.createElement("button")).id="btn-save",t.innerHTML="Save",t.addEventListener("click",(function(t){pt.getInstance().getSaveManager().save(e.chosenSave)&&e.toggle()})),n.push(t),(t=document.createElement("button")).id="btn-load",t.innerHTML="Load",t.addEventListener("click",(function(t){pt.getInstance().getSaveManager().load(e.chosenSave)&&(pt.getInstance().setStarted(),e.toggle())})),n.push(t),(t=document.createElement("button")).id="btn-back",t.innerHTML="Back",t.addEventListener("click",(function(t){e.saveOpened=!1,e.controlsOpened=!1,e.focusedIndex=0,e.setButtons()})),n.push(t),n.forEach((function(t,n){t.addEventListener("mouseover",(function(t){e.setFocused(n),e.setButtons()})),e.menu.appendChild(t),t.hidden=!0})),n},t.prototype.initControlsList=function(){var t=this;pt.getInstance().getController().getControlsString().forEach((function(e){var n=document.createElement("p");n.innerHTML=e,t.controlsList.appendChild(n)}))},t.prototype.setButtons=function(){var t=this;this.saveOpened?(this.title.innerHTML="Save/Load",this.controlsList.hidden=!0,this.mainMenuButtons.forEach((function(t){return t.hidden=!0})),this.saveMenuButtons.forEach((function(e){e.classList.remove("focused"),("btn-save"!=e.id||pt.getInstance().hasStarted())&&(e.hidden=!1),e.id=="btn-save-".concat(t.chosenSave)?e.classList.add("selected"):e.classList.remove("selected")})),this.saveMenuButtons[this.focusedIndex].classList.add("focused")):this.controlsOpened?(this.title.innerHTML="Controls",this.controlsList.hidden=!1,this.mainMenuButtons.forEach((function(t){return t.hidden=!0})),this.saveMenuButtons.forEach((function(t){return t.hidden=!0})),this.saveMenuButtons.at(-1).hidden=!1,this.saveMenuButtons.at(-1).classList.add("focused")):(this.title.innerHTML=pt.getInstance().hasStarted()?"Pause":"Game",this.controlsList.hidden=!0,this.saveMenuButtons.forEach((function(t){return t.hidden=!0})),this.mainMenuButtons.forEach((function(t){t.hidden=!1,t.classList.remove("focused"),"btn-start"==t.id?t.innerHTML=pt.getInstance().hasStarted()?"Resume":"Start":"btn-saves"==t.id&&(t.innerHTML=pt.getInstance().hasStarted()?"Save & Load":"Load")})),this.mainMenuButtons[this.focusedIndex].classList.add("focused"))},t.prototype.processEscape=function(){this.saveOpened||this.controlsOpened?(this.saveOpened=!1,this.controlsOpened=!1,this.focusedIndex=0,this.setButtons()):pt.getInstance().hasStarted()&&this.toggle()},t.prototype.toggle=function(){this.mainOpened=!this.mainOpened,this.mainOpened?(this.menuOverlay.classList.remove("hidden"),this.menu.classList.remove("hidden"),this.setButtons()):(this.menuOverlay.classList.add("hidden"),this.menu.classList.add("hidden"),this.mainMenuButtons.forEach((function(t){return t.hidden=!0})),this.saveMenuButtons.forEach((function(t){return t.hidden=!0})),this.saveOpened=!1,this.focusedIndex=0)},t.prototype.opened=function(){return this.mainOpened},t.prototype.getFocusedButton=function(){return this.controlsOpened?this.saveMenuButtons.at(-1):this.saveOpened?this.saveMenuButtons[this.focusedIndex]:this.mainMenuButtons[this.focusedIndex]},t.prototype.setFocused=function(t){this.focusedIndex=t},t.prototype.nextButton=function(){this.controlsOpened||(++this.focusedIndex>=(this.saveOpened?this.saveMenuButtons.length:this.mainMenuButtons.length)&&(this.focusedIndex=0),!pt.getInstance().hasStarted()&&this.saveOpened&&this.focusedIndex==this.saveBtnIndex&&this.nextButton(),this.setButtons())},t.prototype.prevButton=function(){this.controlsOpened||(--this.focusedIndex<0&&(this.focusedIndex+=this.saveOpened?this.saveMenuButtons.length:this.mainMenuButtons.length),!pt.getInstance().hasStarted()&&this.saveOpened&&this.focusedIndex==this.saveBtnIndex&&this.prevButton(),this.setButtons())},t.prototype.endScreen=function(t){void 0===t&&(t=!0),this.menuOverlay.classList.remove("hidden"),this.endTitle.hidden=!1,this.endTitle.innerHTML=t?"GAME OVER":"YOU WON!"},t}(),pt=function(){function t(){this.playersTurn=!0,this.gameActive=!1,this.entities=[],this.items=[],this.events=[],this.startRules=[],this.finishRules=[],this.move=0,this.gameStarted=!1}return t.getInstance=function(){return this.instance||(this.instance=new t),this.instance},t.prototype.getMove=function(){return this.move},t.prototype.endGame=function(){var t;this.gameActive=!1,null===(t=this.menu)||void 0===t||t.endScreen(this.player.getHP()<=0)},t.prototype.playerActed=function(){var t;this.clearEvents(),null===(t=this.drawer)||void 0===t||t.clearPlayerAction(),this.playersTurn=!1},t.prototype.isActive=function(){return this.gameActive},t.prototype.hasStarted=function(){return this.gameStarted},t.prototype.setStarted=function(){this.gameStarted=!0},t.prototype.isPlayersTurn=function(){return this.playersTurn},t.prototype.loadMap=function(t,e){void 0===t&&(t=this.currentMap),this.clearEvents(),this.clearEntities(),this.clearItems(),this.clearRules(),this.currentMap=t,this.field=this.builder.getPresetMap(t,this.assets),this.setPlayer(e),w()},t.prototype.setMap=function(t,e,n,o,i){this.currentMap=t,this.clearEvents(),this.clearEntities(),this.clearItems(),this.clearRules(),this.field=e,this.entities=n,this.items=o,this.player=i,this.setPlayer(i.getPos()),w()},t.prototype.performAction=function(t){switch(t){case G.MOVE:this.player.move(this.controller.getDirection());break;case G.HIT:this.player.hit(this.controller.getDirection());break;case G.CAST:this.player.castSpell(this.controller.getDirection());break;case G.SLEEP:this.player.sleep(),this.drawer.playerRest();break;case G.PICK_UP:this.player.pickUp(),this.drawer.playerDrop();break;case G.BUFF:this.player.drinkPotion(),this.drawer.playerDrink();break;case G.DROP_W:this.player.dropWeapon(),this.drawer.playerDrop();break;case G.DROP_S:this.player.dropSpell(),this.drawer.playerDrop();break;case G.DROP_A:this.player.dropArmor(),this.drawer.playerDrop();break;case G.DROP_P:this.player.dropPotion(),this.drawer.playerDrop();break;case G.END:this.endGame();break;case G.QSAVE:this.msg("Quick saving..."),this.saveManager.save(0);break;case G.QLOAD:this.msg("Quick loading..."),this.saveManager.load(0)}},t.prototype.start=function(){var t=this;this.gameActive=!0,this.controller=new z,this.drawer=new j,this.saveManager=new Q,this.builder=new B,this.dialogue=new d,this.menu=new ht,this.drawer.addResizeListener(),this.assets=new ct,this.assets.readTilesheets(),this.assets.readEnemies(),this.assets.readNPCs(),this.assets.readItems(),this.player=new _,this.drawer.setPlayerSprite(),this.currentMap="map1",this.loadMap();var e=0,n=function(o){var i,s;t.menu.opened()||(t.playersTurn?t.controller.hasAction()&&(t.performAction(t.controller.getAction()),null===(i=t.controller)||void 0===i||i.clearActions()):t.processEntities(),o-e>=1e3&&(null===(s=t.drawer)||void 0===s||s.toggleAnimFrame(),e=o),t.drawer.clear(),t.drawer.drawField(t.field),t.drawer.drawInfo(),t.drawer.drawLog(),t.drawer.drawDialogue()),window.requestAnimationFrame(n)};window.requestAnimationFrame(n)},t.prototype.getField=function(){return this.field},t.prototype.getPlayer=function(){return this.player},t.prototype.getEntities=function(){return this.entities},t.prototype.getItems=function(){return this.items},t.prototype.setPlayer=function(t){var e,n,o,s;if(t)null===(e=this.field)||void 0===e||e.cellAt(t).setEntity(this.player),null===(n=this.player)||void 0===n||n.setPos(t);else for(var r=0;r<this.field.getWidth();r++)for(var a=0;a<this.field.getHeigth();a++)if(null===(o=this.field)||void 0===o?void 0:o.cellAt(new i(r,a)).isStart()){this.field.cellAt(new i(r,a)).setEntity(this.player),null===(s=this.player)||void 0===s||s.setPos(new i(r,a));break}this.removeDuplicateKeyItems()},t.prototype.getStorage=function(){return this.assets},t.prototype.addEntity=function(t){this.entities.push(t)},t.prototype.addItem=function(t){this.items.push(t)},t.prototype.processEntities=function(){this.entities.forEach((function(t){return t.act()})),this.playersTurn=!0,this.move++},t.prototype.clearEntities=function(){this.entities.length=0},t.prototype.clearItems=function(){this.items.length=0},t.prototype.removeEntity=function(t,e){var n=this;void 0===e&&(e=!1),this.entities=this.entities.filter((function(o){var i;return o!=t||(e&&(null===(i=n.field)||void 0===i||i.cellAt(t.getPos()).setEntity(null)),!1)}))},t.prototype.removeItem=function(t,e){var n=this;void 0===e&&(e=!1),this.items=this.items.filter((function(o){var i;return o!=t||(e&&(null===(i=n.field)||void 0===i||i.cellAt(t.getPos()).setItem(null)),!1)}))},t.prototype.removeItemByName=function(t,e){var n=this;void 0===e&&(e=!1),this.items=this.items.filter((function(o){var i;return o.getName()!=t||(e&&(null===(i=n.field)||void 0===i||i.cellAt(o.getPos()).setItem(null)),!1)}))},t.prototype.isEntityOnField=function(t){return this.entities.includes(t)},t.prototype.countEnemies=function(){return this.entities.filter((function(t){return t instanceof I})).length},t.prototype.countItems=function(){return this.items.length},t.prototype.removeDuplicateKeyItems=function(t){var e,n=this;t?this.removeItemByName(t,!0):null===(e=this.player)||void 0===e||e.getKeyItems().forEach((function(t){n.removeItemByName(t,!0)}))},t.prototype.pushEvent=function(t){this.events.push(t)},t.prototype.clearEvents=function(){this.events.length=0},t.prototype.getEvents=function(){return this.events},t.prototype.addRule=function(t,e){void 0===e&&(e=!0),e?this.startRules.push(t):this.finishRules.push(t)},t.prototype.getRules=function(t){return void 0===t&&(t=!0),t?this.startRules:this.finishRules},t.prototype.clearRules=function(t){void 0===t&&(t=!0),t?this.startRules.length=0:this.finishRules.length=0},t.prototype.getMenu=function(){return this.menu},t.prototype.getDialogue=function(){return this.dialogue},t.prototype.getSaveManager=function(){return this.saveManager},t.prototype.getController=function(){return this.controller},t.prototype.getCurrentMap=function(){return this.currentMap},t.prototype.msg=function(t){console.log(t)},t.prototype.changeScale=function(t){var e;null===(e=this.drawer)||void 0===e||e.changeScale(this.drawer.getScale()+t)},t}();pt.getInstance().start()})()})();