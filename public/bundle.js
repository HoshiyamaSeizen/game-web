(()=>{"use strict";(()=>{var t,e;!function(t){t[t.hitEvent=0]="hitEvent",t[t.castEvent=1]="castEvent",t[t.getHitEvent=2]="getHitEvent",t[t.deadEvent=3]="deadEvent",t[t.breakEvent=4]="breakEvent",t[t.noChargesEvent=5]="noChargesEvent",t[t.restEvent=6]="restEvent",t[t.drinkEvent=7]="drinkEvent",t[t.dropEvent=8]="dropEvent",t[t.pickUpEvent=9]="pickUpEvent",t[t.findEvent=10]="findEvent",t[t.finishEvent=11]="finishEvent",t[t.goalsNotMet=12]="goalsNotMet",t[t.notEnoughMoney=13]="notEnoughMoney",t[t.missingKeyItem=14]="missingKeyItem"}(t||(t={})),function(t){t[t.PLAYER=0]="PLAYER",t[t.ENEMY=1]="ENEMY",t[t.ITEM=2]="ITEM"}(e||(e={}));var n,i=function(){function e(t,e,n,i,o,s){void 0===n&&(n="you"),void 0===i&&(i="you"),void 0===o&&(o=0),void 0===s&&(s=0),this.source=t,this.type=e,this.subject=n,this.object=i,this.numValue=o,this.hp=s}return e.prototype.getSource=function(){return this.source},e.prototype.toString=function(){var e;switch(this.type){case t.hitEvent:e="".concat(this.subject," hit ").concat(this.object," with ").concat(this.numValue," damage");break;case t.castEvent:e="".concat(this.subject," casted a spell on ").concat(this.object," dealing ").concat(this.numValue," damage");break;case t.getHitEvent:e="".concat(this.subject," (").concat(this.hp,") recieved ").concat(this.numValue," damage");break;case t.deadEvent:e="".concat(this.subject," was slayed");break;case t.breakEvent:e="your ".concat(this.subject," is broken");break;case t.noChargesEvent:e="your ".concat(this.subject," has no charges left");break;case t.restEvent:e="you rested and restored ".concat(this.numValue," HP and SP");break;case t.drinkEvent:e="you drank ".concat(this.subject," and restored ").concat(this.numValue," ").concat(this.object);break;case t.dropEvent:e="you dropped your ".concat(this.subject);break;case t.pickUpEvent:e="you picked up ".concat(this.subject);break;case t.findEvent:e="you found ".concat(this.subject);break;case t.finishEvent:e="you reached the finish";break;case t.goalsNotMet:e="you need to complete the goals";break;case t.notEnoughMoney:e="you don't have enough money. You need ".concat(this.numValue);break;case t.missingKeyItem:e="you need ".concat(this.subject," to proceed");break;default:return" "}return e.charAt(0).toUpperCase()+e.slice(1)},e}();!function(t){t[t.N=0]="N",t[t.E=1]="E",t[t.S=2]="S",t[t.W=3]="W",t[t.NE=4]="NE",t[t.SE=5]="SE",t[t.SW=6]="SW",t[t.NW=7]="NW"}(n||(n={}));var o,s,a,r,h=function(){function t(t,e){this.x=t,this.y=e}return t.prototype.equals=function(t){return this.x==t.x&&this.y==t.y},t.prototype.compare=function(t){return this.equals(t)?0:this.x<t.x||this.x==t.x&&this.y<t.y?-1:1},t.prototype.dist=function(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))},t.prototype.toString=function(){return"(".concat(this.x,", ").concat(this.y,")")},t}(),c=function(t,e){var i=new h(t.x,t.y);switch(e){case n.N:i.y--;break;case n.NE:i.x++,i.y--;break;case n.E:i.x++;break;case n.SE:i.x++,i.y++;break;case n.S:i.y++;break;case n.SW:i.x--,i.y++;break;case n.W:i.x--;break;case n.NW:i.x--,i.y--}return i},p=function(t,e){var i=e.x-t.x,o=e.y-t.y;return i>0&&o>0?n.SE:0==i&&o>0?n.S:i<0&&o>0?n.SW:i<0&&0==o?n.W:i<0&&o<0?n.NW:0==i&&o<0?n.N:i>0&&o<0?n.NE:n.E},u=function(t,e){return Math.abs(t.x-e.x)<=1&&Math.abs(t.y-e.y)<=1},l=function(){return Math.floor(8*Math.random())},d=function(){function t(){}return t.prototype.getSprite=function(){return this.sprite},t.prototype.getUSprite=function(){return this.spriteWhenUsed},t.prototype.setSprite=function(t){this.sprite=t},t.prototype.setUSprite=function(t){this.spriteWhenUsed=t},t}(),g=function(){function t(){}return t.prototype.getTilePos=function(){return this.tilePos},t.prototype.setTilePos=function(t){this.tilePos=t},t}(),y=(o=function(t,e){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},o(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),m=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.pos=new h(0,0),e.prevDir=n.S,e}return y(e,t),e.prototype.setPos=function(t){this.pos=t},e.prototype.getDir=function(){return this.prevDir},e.prototype.getPos=function(){return this.pos},e}(d);!function(t){t[t.START=0]="START",t[t.FINISH=1]="FINISH"}(s||(s={})),function(t){t[t.ENTITY=0]="ENTITY",t[t.ITEM=1]="ITEM"}(a||(a={})),function(t){t[t.HP=0]="HP",t[t.MHP=1]="MHP",t[t.MP=2]="MP",t[t.MMP=3]="MMP",t[t.SP=4]="SP",t[t.MSP=5]="MSP",t[t.DEF=6]="DEF",t[t.DAM=7]="DAM",t[t.MONEY=8]="MONEY",t[t.COST=9]="COST",t[t.DUR=10]="DUR",t[t.PRICE=11]="PRICE",t[t.COUNT=12]="COUNT",t[t.KILL=13]="KILL",t[t.SCORE=14]="SCORE"}(r||(r={}));var f=function(){function t(t,e,n,i,o){this._type=t,this._target=e,this._name=n,this._condition=i,this._value=o}return t.prototype.type=function(){return this._type},t.prototype.target=function(){return this._target},t.prototype.name=function(){return this._name},t.prototype.condition=function(){return this._condition},t.prototype.value=function(){return this._value},t}(),v=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),w=function(n){function o(t,e,i,o){void 0===t&&(t=1),void 0===e&&(e=1),void 0===i&&(i=1),void 0===o&&(o=0);var s=n.call(this)||this;return s.reward=0,s.sound="",s.health=t,s.maxHealth=t,s.armor=e,s.damage=i,s.reward=o,s.name="",s}return v(o,n),o.prototype.act=function(){var t;null===(t=this.strategy)||void 0===t||t.execute()},o.prototype.changeStat=function(t,e){switch(t){case r.HP:this.health=e,this.health>this.maxHealth&&(this.health=this.maxHealth);break;case r.MHP:this.maxHealth=e;break;case r.DEF:this.armor=e;break;case r.DAM:this.damage=e;break;case r.MONEY:this.reward=e}},o.prototype.move=function(t){var e=c(this.pos,t);this.movePos(e)},o.prototype.movePos=function(t){var e=gt.getInstance().getMapManager().getField();e.isInField(t)&&e.cellAt(t).isFree()&&(e.cellAt(this.pos).setEntity(null),e.cellAt(t).setEntity(this),this.prevDir=p(this.pos,t),this.pos=t)},o.prototype.hit=function(t){var e=gt.getInstance().getMapManager().getField(),n=c(this.pos,t);e.isInField(n)&&!e.cellAt(n).isFree()&&e.cellAt(n).isAccessible()&&this.hitEntity(e.cellAt(n).getEntity())},o.prototype.hitEntity=function(n){gt.getInstance().pushEvent(new i(e.ENEMY,t.hitEvent,this.name,n.getName(),this.damage)),this.prevDir=p(this.pos,n.getPos()),n.getHit(this.damage)},o.prototype.getHit=function(n){var o=gt.getInstance(),s=n-(this.armor?Math.floor(n/this.armor--):0);this.health-=s,o.pushEvent(new i(e.ENEMY,t.getHitEvent,this.name,"",s,this.health)),this.health<=0&&(o.getAudioManager().playAudio("kill",.5),o.getMapManager().getField().cellAt(this.pos).setEntity(null),o.removeEntity(this),o.pushEvent(new i(e.ENEMY,t.deadEvent,this.name)),o.getPlayer().addMoney(this.reward))},o.prototype.changeStrategy=function(t){this.strategy=t},o.prototype.changeName=function(t){this.name=t},o.prototype.getName=function(){return this.name},o.prototype.getHP=function(){return this.health},o.prototype.getmaxHP=function(){return this.maxHealth},o.prototype.getReward=function(){return this.reward},o.prototype.setSound=function(t){this.sound=t},o.prototype.getSound=function(){return this.sound},o.prototype.clone=function(){var t=new o(this.maxHealth,this.armor,this.damage,this.reward);return t.strategy=this.strategy.clone(t),t.sprite=this.sprite,t.prevDir=this.prevDir,t.name=this.name,t.sound=this.sound,t},o}(m);const E=JSON.parse('["town","dungeon","win","loss","spell","hitBlunt","hitSharp","hitHand","zombie","halt","hound","ghost","majin","kill","potion","select","sleep"]');var S,P=function(){function t(){var t=this;this.audio=new Map,this.volume=1,this.background="",this.bgVolume=1,this.rangeSFX=document.getElementById("range-sfx"),this.rangeBG=document.getElementById("range-bg"),this.rangeSFX.addEventListener("change",(function(){return t.volume=+t.rangeSFX.value})),this.rangeBG.addEventListener("change",(function(){return t.bgVolume=+t.rangeBG.value}))}return t.prototype.readAudio=function(){var t=this;return Promise.all(E.map((function(e){return new Promise((function(n,i){var o;t.audio.set(e,new Audio("assets/audio/".concat(e,".mp3"))),null===(o=t.audio.get(e))||void 0===o||o.addEventListener("canplaythrough",(function(){return n()}))}))})))},t.prototype.playAudio=function(t,e,n){void 0===e&&(e=1),void 0===n&&(n=!1);var i=this.audio.get(t);i&&(i.volume=this.volume*e,i.loop=n,i.play())},t.prototype.pauseAudio=function(t){var e;null===(e=this.audio.get(t))||void 0===e||e.pause()},t.prototype.stopAllSFX=function(){var t=this;this.audio.forEach((function(e,n){n!==t.background&&(e.pause(),e.currentTime=0)}))},t.prototype.playBackground=function(){var t=this.audio.get(this.background);t&&(t.volume=this.bgVolume,t.loop=!0,t.play())},t.prototype.setBackground=function(t){this.background!==t&&(this.background&&this.stopBackground(),this.background=t,gt.getInstance().hasStarted()&&this.playBackground())},t.prototype.pauseBackground=function(){this.pauseAudio(this.background)},t.prototype.stopBackground=function(){this.audio.get(this.background).currentTime=0,this.pauseBackground()},t.prototype.loadAudioSettings=function(){this.rangeSFX.value=this.volume.toString(),this.rangeBG.value=this.bgVolume.toString()},t}(),M=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();!function(t){t[t.RANDOM=0]="RANDOM",t[t.ORDER=1]="ORDER"}(S||(S={}));var I,b=function(t){function e(){var e=t.call(this)||this;return e.phrases=[],e.tType=S.RANDOM,e.phraseIndex=0,e.phraseCount=0,e.name="",e}return M(e,t),e.prototype.changeStat=function(t,e){},e.prototype.act=function(){var t;null===(t=this.strategy)||void 0===t||t.execute()},e.prototype.move=function(t){var e=c(this.pos,t);this.movePos(e)},e.prototype.movePos=function(t){var e=gt.getInstance().getMapManager().getField();e.isInField(t)&&e.cellAt(t).isFree()&&(e.cellAt(this.pos).setEntity(null),e.cellAt(t).setEntity(this),this.prevDir=p(this.pos,t),this.pos=t)},e.prototype.setPhrases=function(t){this.phrases=t,this.phraseCount=t.length},e.prototype.getPhrases=function(){return this.phrases},e.prototype.getPhraseCount=function(){return this.phraseCount},e.prototype.readPhrase=function(){var t="";return this.tType==S.ORDER?(t=this.phrases[this.phraseIndex],this.phraseIndex++,this.phraseIndex>=this.phrases.length&&(this.phraseIndex=0)):this.tType==S.RANDOM&&(t=this.phrases[Math.round(Math.random()*(this.phrases.length-1))]),t},e.prototype.setTalkType=function(t){this.tType=t},e.prototype.setPhraseIndex=function(t){this.phraseIndex=t},e.prototype.getTalkType=function(){return this.tType},e.prototype.getPhraseIndex=function(){return this.phraseIndex},e.prototype.changeStrategy=function(t){this.strategy=t},e.prototype.changeName=function(t){this.name=t},e.prototype.getName=function(){return this.name},e.prototype.getHP=function(){return 0},e.prototype.hit=function(t){},e.prototype.hitEntity=function(t){},e.prototype.getHit=function(t){},e.prototype.clone=function(){var t=new e;return t.strategy=this.strategy.clone(t),t.sprite=this.sprite,t.prevDir=this.prevDir,t.name=this.name,t.phrases=this.phrases,t.phraseCount=this.phraseCount,t.tType=this.tType,t},e}(m),x=function(){function t(){this.target=null,this.isOpened=!1,this.text=""}return t.prototype.setTarget=function(t){this.target=t,this.isOpened=!0,this.text=t.readPhrase()},t.prototype.getTarget=function(){return this.target},t.prototype.opened=function(){return this.isOpened},t.prototype.close=function(){this.isOpened=!1,this.target=null,this.text=""},t.prototype.getText=function(){return this.text},t.prototype.next=function(){this.text=this.target.readPhrase()},t.prototype.shouldProceed=function(){return this.target.getTalkType()==S.ORDER&&0!=this.target.getPhraseIndex()},t}(),A=function(t){void 0===t&&(t=!1),gt.getInstance().getRules().forEach((function(e){e.target()==a.ENTITY?("player"!=e.name()&&"all"!=e.name()||(!t||e.condition()!=r.HP&&e.condition()!=r.MP&&e.condition()!=r.SP)&&gt.getInstance().getPlayer().changeStat(e.condition(),e.value()),gt.getInstance().getEntities().forEach((function(n){e.name()!=n.getName()&&"all"!=e.name()||t&&e.condition()==r.HP||n.changeStat(e.condition(),e.value())}))):e.target()==a.ITEM&&gt.getInstance().getItems().forEach((function(n){e.name()!=n.getName()&&"all"!=e.name()||t&&e.condition()==r.DUR||n.changeStat(e.condition(),e.value())}))}))},k=function(){return gt.getInstance().getRules(!1).every((function(t){var e=!0,n=0;return t.target()==a.ENTITY?gt.getInstance().getEntities().forEach((function(i){i instanceof w&&(t.name()==i.getName()||"all"==t.name())&&(t.condition()==r.COUNT?n++:t.condition()==r.KILL&&(e=!1))})):(t.target(),a.ITEM),t.condition()==r.COUNT&&n>t.value()&&(e=!1),e}))},T=function(t){var e,n,i,o,h;e="start"==t[0]?s.START:s.FINISH,"entity"==t[1]?n=a.ENTITY:"item"==t[1]&&(n=a.ITEM),i=t[2],"hp"==t[3]?o=r.HP:"mhp"==t[3]?o=r.MHP:"mp"==t[3]?o=r.MP:"mmp"==t[3]?o=r.MMP:"sp"==t[3]?o=r.SP:"msp"==t[3]?o=r.MSP:"def"==t[3]?o=r.DEF:"dam"==t[3]?o=r.DAM:"money"==t[3]?o=r.MONEY:"cost"==t[3]?o=r.COST:"dur"==t[3]?o=r.DUR:"price"==t[3]?o=r.PRICE:"kill"==t[3]?o=r.KILL:"count"==t[3]&&(o=r.COUNT),h=+t[4],gt.getInstance().addRule(new f(e,n,i,o,h),e==s.START)},O=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),C=function(n){function o(t,e,i,o){void 0===t&&(t=1),void 0===e&&(e=1),void 0===i&&(i=10),void 0===o&&(o="");var s=n.call(this)||this;return s.moneyCost=0,s.sound="",s.damage=t,s.cost=e,s.durability=i,s.sound=o,s.name="Weapon",s}return O(o,n),o.prototype.getName=function(){return this.name},o.prototype.getDamage=function(){return this.damage},o.prototype.getCost=function(){return this.cost},o.prototype.changeStat=function(t,e){switch(t){case r.DAM:this.damage=e;break;case r.COST:this.cost=e;break;case r.DUR:this.durability=e;break;case r.PRICE:this.moneyCost=e}},o.prototype.getDur=function(){return this.durability},o.prototype.setDur=function(t){this.durability=t},o.prototype.setMoneyCost=function(t){this.moneyCost=t},o.prototype.getMoneyCost=function(){return this.moneyCost},o.prototype.getSound=function(){return this.sound},o.prototype.decreaseDur=function(){this.durability--,this.durability<=0&&(gt.getInstance().pushEvent(new i(e.ITEM,t.breakEvent,this.name)),gt.getInstance().getPlayer().setWeapon(null),gt.getInstance().removeItem(this))},o.prototype.changeName=function(t){this.name=t},o.prototype.clone=function(){var t=new o(this.damage,this.cost,this.durability);return t.name=this.name,t.sprite=this.sprite,t.spriteWhenUsed=this.spriteWhenUsed,t.moneyCost=this.moneyCost,t.sound=this.sound,t},o}(m),N=function(n){function o(t,e,i,o){void 0===t&&(t=1),void 0===e&&(e=1),void 0===i&&(i=1),void 0===o&&(o="");var s=n.call(this)||this;return s.moneyCost=0,s.sound="",s.damage=t,s.cost=e,s.charges=i,s.sound=o,s.name="Spell",s}return O(o,n),o.prototype.getName=function(){return this.name},o.prototype.getDamage=function(){return this.damage},o.prototype.getCost=function(){return this.cost},o.prototype.changeStat=function(t,e){switch(t){case r.DAM:this.damage=e;break;case r.COST:this.cost=e;break;case r.DUR:this.charges=e;break;case r.PRICE:this.moneyCost=e}},o.prototype.getDur=function(){return this.charges},o.prototype.setDur=function(t){this.charges=t},o.prototype.setMoneyCost=function(t){this.moneyCost=t},o.prototype.getMoneyCost=function(){return this.moneyCost},o.prototype.decreaseDur=function(){this.charges--,this.charges<=0&&(gt.getInstance().pushEvent(new i(e.ITEM,t.noChargesEvent,this.name)),gt.getInstance().getPlayer().setSpell(null),gt.getInstance().removeItem(this))},o.prototype.changeName=function(t){this.name=t},o.prototype.getSound=function(){return this.sound},o.prototype.clone=function(){var t=new o(this.damage,this.cost,this.charges);return t.name=this.name,t.sprite=this.sprite,t.spriteWhenUsed=this.spriteWhenUsed,t.moneyCost=this.moneyCost,t},o}(m),R=function(n){function o(t,e){void 0===t&&(t=1),void 0===e&&(e=10);var i=n.call(this)||this;return i.moneyCost=0,i.armor=t,i.durability=e,i.name="Armor",i}return O(o,n),o.prototype.getName=function(){return this.name},o.prototype.getArmor=function(){return this.armor},o.prototype.changeStat=function(t,e){switch(t){case r.DEF:this.armor=e;break;case r.DUR:this.durability=e;break;case r.PRICE:this.moneyCost=e}},o.prototype.getDur=function(){return this.durability},o.prototype.setDur=function(t){this.durability=t},o.prototype.setMoneyCost=function(t){this.moneyCost=t},o.prototype.getMoneyCost=function(){return this.moneyCost},o.prototype.decreaseDur=function(){this.durability--,this.durability<=0&&(gt.getInstance().pushEvent(new i(e.ITEM,t.breakEvent,this.name)),gt.getInstance().getPlayer().setArmor(null),gt.getInstance().removeItem(this))},o.prototype.changeName=function(t){this.name=t},o.prototype.clone=function(){var t=new o(this.armor,this.durability);return t.name=this.name,t.sprite=this.sprite,t.spriteWhenUsed=this.spriteWhenUsed,t.moneyCost=this.moneyCost,t},o}(m);!function(t){t[t.HP=0]="HP",t[t.SP=1]="SP",t[t.MP=2]="MP"}(I||(I={}));var D,_=function(t){function e(e,n){void 0===e&&(e=I.HP),void 0===n&&(n=50);var i=t.call(this)||this;return i.moneyCost=0,i.type=e,i.amount=n,i.name="Potion",i}return O(e,t),e.prototype.getName=function(){return this.name},e.prototype.getType=function(){return this.type},e.prototype.getAmount=function(){return this.amount},e.prototype.changeStat=function(t,e){switch(t){case r.HP:this.type=I.HP,this.amount=e;break;case r.MP:this.type=I.MP,this.amount=e;break;case r.SP:this.type=I.SP,this.amount=e;break;case r.PRICE:this.moneyCost=e}},e.prototype.getDur=function(){return 1},e.prototype.setDur=function(t){},e.prototype.setMoneyCost=function(t){this.moneyCost=t},e.prototype.getMoneyCost=function(){return this.moneyCost},e.prototype.decreaseDur=function(){gt.getInstance().getPlayer().setPotion(null),gt.getInstance().removeItem(this)},e.prototype.changeName=function(t){this.name=t},e.prototype.clone=function(){var t=new e(this.type,this.amount);return t.name=this.name,t.sprite=this.sprite,t.spriteWhenUsed=this.spriteWhenUsed,t.moneyCost=this.moneyCost,t},e}(m),L=function(t){function e(){var e=t.call(this)||this;return e.name="KeyItem",e.moneyCost=0,e}return O(e,t),e.prototype.changeName=function(t){this.name=t},e.prototype.getName=function(){return this.name},e.prototype.setMoneyCost=function(t){this.moneyCost=t},e.prototype.getMoneyCost=function(){return this.moneyCost},e.prototype.clone=function(){var t=new e;return t.name=this.name,t.moneyCost=this.moneyCost,t.sprite=this.sprite,t},e.prototype.changeStat=function(t,e){},e.prototype.decreaseDur=function(){},e.prototype.setDur=function(t){},e.prototype.getDur=function(){return 0},e}(m),H=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),B=function(n){function o(t,e,i,o){void 0===t&&(t=1e3),void 0===e&&(e=100),void 0===i&&(i=100),void 0===o&&(o=50);var s=n.call(this)||this;return s.weapon=null,s.armor=null,s.spell=null,s.potion=null,s.maxHealth=t,s.health=t,s.maxStamina=i,s.stamina=i,s.maxMana=e,s.mana=e,s.damage=o,s.money=0,s.score=0,s.keyItems=[],s.name="you",s.game=gt.getInstance(),s}return H(o,n),o.prototype.changeStat=function(t,e){switch(t){case r.HP:this.health=e;break;case r.MHP:this.maxHealth=e;break;case r.MP:this.mana=e;break;case r.MMP:this.maxMana=e;break;case r.SP:this.stamina=e;break;case r.MSP:this.maxStamina=e;break;case r.DAM:this.damage=e;break;case r.MONEY:this.money=e;break;case r.SCORE:this.score=e}},o.prototype.move=function(t){var e=c(this.pos,t);this.movePos(e)},o.prototype.movePos=function(n){var o,s=this.game.getMapManager().getField();if(s.isInField(n)){if(s.cellAt(n).isFree())s.cellAt(this.pos).setEntity(null),s.cellAt(n).setEntity(this);else{if(!(s.cellAt(n).getEntity()instanceof b))return;var a=s.cellAt(n).getEntity();a.setPos(this.pos),s.cellAt(this.pos).setEntity(a),s.cellAt(n).setEntity(this)}if(this.prevDir=p(this.pos,n),this.pos=n,this.game.playerActed(),s.cellAt(this.pos).isFinish()){var r=s.cellAt(this.pos).getTransition();!r||r.followRules&&!k()||r.key&&!this.keyItems.includes(r.key)?r&&r.key&&!this.keyItems.includes(r.key)?this.game.pushEvent(new i(e.PLAYER,t.missingKeyItem,r.key)):k()?(this.game.pushEvent(new i(e.PLAYER,t.finishEvent)),this.game.endGame()):this.game.pushEvent(new i(e.PLAYER,t.goalsNotMet)):this.game.getMapManager().loadMap(r.map,new h(r.x,r.y))}else s.cellAt(n).hasItem()&&this.game.pushEvent(new i(e.PLAYER,t.findEvent,null===(o=s.cellAt(n).getItem())||void 0===o?void 0:o.getName()))}},o.prototype.hit=function(t){var e,n=this.game.getMapManager().getField(),i=c(this.pos,t);if(this.game.getAudioManager().playAudio((null===(e=this.getWeapon())||void 0===e?void 0:e.getSound())||"hitHand",.5),n.isInField(i)&&!n.cellAt(i).isFree()&&n.cellAt(i).isAccessible()){var o=n.cellAt(i).getEntity();this.hitEntity(o)}},o.prototype.hitEntity=function(n){if(n instanceof b)this.talk(n);else{var o=this.damage+(this.weapon?this.weapon.getDamage():0),s=1+(this.weapon?this.weapon.getCost():0);this.stamina>=s&&(this.stamina-=s,this.prevDir=p(this.pos,n.getPos()),this.game.playerActed(),this.game.pushEvent(new i(e.PLAYER,t.hitEvent,this.name,n.getName(),o)),this.weapon&&this.weapon.decreaseDur(),n.getHit(o))}},o.prototype.castSpell=function(n){var o=this.game.getMapManager().getField(),s=this.spell?this.spell.getDamage():0,a=this.spell?this.spell.getCost():0;this.getSpell()&&this.game.getAudioManager().playAudio(this.getSpell().getSound(),.5);var r=c(this.pos,n);if(o.isInField(r)&&!o.cellAt(r).isFree()&&o.cellAt(r).isAccessible()){var h=o.cellAt(r).getEntity();if(h instanceof b)return void this.talk(h);this.mana>=a&&this.spell&&(this.mana-=a,this.prevDir=n,this.game.playerActed(),this.game.pushEvent(new i(e.PLAYER,t.castEvent,this.name,h.getName(),s)),this.spell.decreaseDur(),h.getHit(s))}},o.prototype.talk=function(t){this.game.getDialogue().setTarget(t)},o.prototype.drinkPotion=function(){if(this.hasPotion()){var n=this.potion.getAmount(),o=this.potion.getType(),s="";o==I.HP?(this.health=this.health+n>=this.maxHealth?this.maxHealth:this.health+n,s="HP"):o==I.SP?(this.stamina=this.stamina+n>=this.maxStamina?this.maxStamina:this.stamina+n,s="SP"):o==I.MP&&(this.mana=this.mana+n>=this.maxMana?this.maxMana:this.mana+n,s="MP"),this.game.playerActed(),this.game.pushEvent(new i(e.PLAYER,t.drinkEvent,this.potion.getName(),s,n)),this.potion.decreaseDur(),this.game.getAudioManager().playAudio("potion")}},o.prototype.getHit=function(n){var o=n-(this.armor?Math.round(n/this.armor.getArmor()):0);this.health-=o,this.armor&&this.armor.decreaseDur(),this.game.pushEvent(new i(e.PLAYER,t.getHitEvent,this.name,"",o,this.health)),this.health<=0&&(this.game.getMapManager().getField().cellAt(this.pos).setEntity(null),this.game.pushEvent(new i(e.PLAYER,t.deadEvent,this.name)),this.game.endGame())},o.prototype.sleep=function(){this.health+=10,this.health>=this.maxHealth&&(this.health=this.maxHealth),this.stamina+=10,this.stamina>=this.maxStamina&&(this.stamina=this.maxStamina),this.mana+=10,this.mana>=this.maxMana&&(this.mana=this.maxMana),this.game.playerActed(),this.game.pushEvent(new i(e.PLAYER,t.restEvent,"","",10)),this.game.getAudioManager().playAudio("sleep")},o.prototype.pickUp=function(){var n=this.game.getMapManager().getField();if(n.cellAt(this.pos).hasItem()){var o=n.cellAt(this.pos).getItem();if(o.getMoneyCost()>this.money)return this.game.playerActed(),void this.game.pushEvent(new i(e.PLAYER,t.notEnoughMoney,"","",o.getMoneyCost()));this.money-=o.getMoneyCost(),o.setMoneyCost(0),n.cellAt(this.pos).setItem(null),this.game.removeItem(o),o instanceof C?(this.weapon&&this.dropWeapon(),this.weapon=o):o instanceof N?(this.spell&&this.dropSpell(),this.spell=o):o instanceof R?(this.armor&&this.dropArmor(),this.armor=o):o instanceof _?(this.potion&&this.dropPotion(),this.potion=o):o instanceof L&&(this.keyItems.push(o.getName()),this.game.removeDuplicateKeyItems(o.getName())),this.game.playerActed(),this.game.getAudioManager().playAudio("select"),this.game.pushEvent(new i(e.PLAYER,t.pickUpEvent,o.getName()))}},o.prototype.dropWeapon=function(){var n=this.game.getMapManager().getField();!n.cellAt(this.pos).hasItem()&&this.weapon&&(n.cellAt(this.pos).setItem(this.weapon),this.weapon.setPos(this.pos),this.game.addItem(this.weapon),this.game.pushEvent(new i(e.PLAYER,t.dropEvent,this.weapon.getName())),this.weapon=null,this.game.getAudioManager().playAudio("select"))},o.prototype.dropSpell=function(){var n=this.game.getMapManager().getField();!n.cellAt(this.pos).hasItem()&&this.spell&&(n.cellAt(this.pos).setItem(this.spell),this.spell.setPos(this.pos),this.game.addItem(this.spell),this.game.pushEvent(new i(e.PLAYER,t.dropEvent,this.spell.getName())),this.spell=null,this.game.getAudioManager().playAudio("select"))},o.prototype.dropPotion=function(){var n=this.game.getMapManager().getField();!n.cellAt(this.pos).hasItem()&&this.potion&&(n.cellAt(this.pos).setItem(this.potion),this.potion.setPos(this.pos),this.game.addItem(this.potion),this.game.pushEvent(new i(e.PLAYER,t.dropEvent,this.potion.getName())),this.potion=null,this.game.getAudioManager().playAudio("select"))},o.prototype.dropArmor=function(){var n=this.game.getMapManager().getField();!n.cellAt(this.pos).hasItem()&&this.armor&&(n.cellAt(this.pos).setItem(this.armor),this.armor.setPos(this.pos),this.game.addItem(this.armor),this.game.pushEvent(new i(e.PLAYER,t.dropEvent,this.armor.getName())),this.armor=null,this.game.getAudioManager().playAudio("select"))},o.prototype.getWeapon=function(){return this.weapon},o.prototype.getArmor=function(){return this.armor},o.prototype.getSpell=function(){return this.spell},o.prototype.getPotion=function(){return this.potion},o.prototype.getKeyItems=function(){return this.keyItems},o.prototype.getName=function(){return this.name},o.prototype.getHP=function(){return this.health},o.prototype.getSP=function(){return this.stamina},o.prototype.getMP=function(){return this.mana},o.prototype.setWeapon=function(t){this.weapon=t},o.prototype.setSpell=function(t){this.spell=t},o.prototype.setArmor=function(t){this.armor=t},o.prototype.setPotion=function(t){this.potion=t},o.prototype.setKeyItems=function(t){this.keyItems=t},o.prototype.hasWeapon=function(){return null!=this.weapon},o.prototype.hasSpell=function(){return null!=this.spell},o.prototype.hasArmor=function(){return null!=this.armor},o.prototype.hasPotion=function(){return null!=this.potion},o.prototype.hasKeyItems=function(){return 0!=this.keyItems.length},o.prototype.getScore=function(){return this.score},o.prototype.getMoney=function(){return this.money},o.prototype.addMoney=function(t){this.money+=t,this.score+=t},o.prototype.act=function(){},o.prototype.clone=function(){var t=new o(1e3,100,100,50);return t.sprite=this.sprite,t},o}(m),F=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();!function(t){t[t.normal=0]="normal",t[t.start=1]="start",t[t.finish=2]="finish"}(D||(D={}));var K=function(t){function e(e,n,i,o){void 0===e&&(e=D.normal),void 0===n&&(n=!0),void 0===i&&(i=null),void 0===o&&(o=null);var s=t.call(this)||this;return s.accessible=n,s.state=e,s.entity=i,s.item=o,s}return F(e,t),e.prototype.getState=function(){return this.state},e.prototype.getItem=function(){return this.item},e.prototype.getEntity=function(){return this.entity},e.prototype.getTransition=function(){return this.transition||null},e.prototype.hasItem=function(){return!!this.item&&this.isAccessible()},e.prototype.isFree=function(){return!this.entity&&this.isAccessible()},e.prototype.isEntityPlayer=function(){return this.entity instanceof B},e.prototype.isEntityEnemy=function(){return this.entity instanceof w},e.prototype.isEntityNPC=function(){return this.entity instanceof b},e.prototype.isStart=function(){return this.state==D.start},e.prototype.isFinish=function(){return this.state==D.finish},e.prototype.isAccessible=function(){return this.accessible},e.prototype.setEntity=function(t){this.entity=t},e.prototype.setItem=function(t){this.item=t},e.prototype.setState=function(t){this.state=t},e.prototype.toggleAccessibility=function(){this.accessible=!this.accessible},e.prototype.setTransition=function(t){this.transition=t},e}(g),W=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.width=t,this.height=e,this.cells=Array.from(Array(t),(function(){return new Array(e)}));for(var n=0;n<t;n++)for(var i=0;i<e;i++)this.cells[n][i]=new K}return t.prototype.cellAt=function(t){var e=t instanceof h?t:new h(t.x,t.y);if(!this.isInField(e))throw new Error("Not in a field");return this.cells[t.x][t.y]},t.prototype.getWidth=function(){return this.width},t.prototype.getHeigth=function(){return this.height},t.prototype.isInField=function(t){return t.x>=0&&t.x<this.width&&t.y>=0&&t.y<this.height},t.prototype.log=function(){for(var t="",e=0;e<this.height;e++){for(var n=0;n<this.width;n++)this.cells[n][e].isAccessible()||this.cells[n][e].isFinish()?this.cells[n][e].isEntityPlayer()?t+="p ":this.cells[n][e].isEntityEnemy()?t+="e ":this.cells[n][e].isAccessible()?this.cells[n][e].isStart()?t+="s ":this.cells[n][e].isFinish()?t+="f ":this.cells[n][e].hasItem()?t+="i ":t+="  ":t+="b ":t+="x ";t+="\n"}console.log(t)},t.prototype.removeEntity=function(t){for(var e=0;e<this.width;e++)for(var n=0;n<this.height;n++)this.cells[e][n].getEntity()==t&&this.cells[e][n].setEntity(null)},t.prototype.removeItem=function(t){for(var e=0;e<this.width;e++)for(var n=0;n<this.height;n++)this.cells[e][n].getItem()==t&&this.cells[e][n].setItem(null)},t}();const j=JSON.parse('[{"compressionlevel":-1,"height":10,"infinite":false,"layers":[{"data":[5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,1,1,1,1,1,1,1,1,1,5,5,5,1,2,3,3,4,1,5,1,1,1,1,1,1,1,5,5,3,4,1,1,1,1,1,1,1,1,1,1,1,10,11,11,12,1,1,1,1,1,1,1,1,1,5,5,11,12,1,1,1,1,1,1,1,1,1,1,1,18,19,19,20,1,5,1,1,1,1,1,1,1,5,5,11,12,1,1,1,1,1,1,1,5,5,5,1,1,1,5,5,5,5,5,5,5,5,5,5,5,5,5,11,21,4,21,1,21,1,21,1,5,5,5,1,1,1,5,5,5,5,5,5,5,13,5,5,5,5,5,11,11,12,1,1,1,1,1,1,5,5,5,1,1,1,1,1,5,1,1,1,1,1,1,5,5,5,5,11,17,12,1,1,1,1,9,1,5,5,5,1,1,1,5,1,5,1,5,5,1,1,1,5,5,5,5,11,11,12,1,1,1,1,1,1,5,5,5,1,1,1,5,1,1,1,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],"height":10,"id":1,"name":"TileLayer","opacity":1,"type":"tilelayer","visible":true,"width":28,"x":0,"y":0},{"data":[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,0,0,0,0,0,0,0,0,0,64,64,64,0,0,0,0,0,0,64,0,0,0,0,0,0,0,64,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,64,64,0,0,0,0,0,0,0,0,0,64,64,64,0,0,0,64,64,64,64,64,64,64,64,64,64,64,64,64,0,64,0,64,0,64,0,64,0,64,64,64,0,0,0,64,64,64,64,64,64,64,0,64,64,64,64,64,0,0,0,0,0,0,0,0,0,64,64,64,0,0,0,0,0,64,0,0,0,0,0,0,64,64,64,64,0,0,0,0,0,0,0,0,0,64,64,64,0,0,0,64,0,64,0,64,64,0,0,0,64,64,64,64,0,0,0,0,0,0,0,0,0,64,64,64,0,0,0,64,0,0,0,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],"height":10,"id":3,"name":"Walls","opacity":1,"type":"tilelayer","visible":false,"width":28,"x":0,"y":0},{"draworder":"topdown","id":2,"name":"ObjectLayer","objects":[{"class":"NPC","ellipse":true,"height":32,"id":4,"name":"Guide","rotation":0,"visible":true,"width":32,"x":448,"y":256},{"class":"Transition","height":32,"id":5,"name":"_1","properties":[{"name":"transition","type":"string","value":"{ \\"map\\": \\"map3\\", \\"x\\": 1, \\"y\\": 5, \\"followRules\\": false, \\"key\\": null }"}],"rotation":0,"visible":true,"width":32,"x":736,"y":160},{"class":"Transition","height":32,"id":7,"name":"_2","properties":[{"name":"transition","type":"string","value":"{ \\"map\\": \\"map2\\", \\"x\\": 1, \\"y\\": 5, \\"followRules\\": false, \\"key\\": null }"}],"rotation":0,"visible":true,"width":32,"x":64,"y":224},{"class":"Transition","height":32,"id":8,"name":"_3","properties":[{"name":"transition","type":"string","value":"{ \\"map\\": \\"map2\\", \\"x\\": 19, \\"y\\": 4, \\"followRules\\": false, \\"key\\": \\"Key\\" }"}],"rotation":0,"visible":true,"width":32,"x":256,"y":224},{"class":"Item","height":32,"id":11,"name":"Healing_Potion","rotation":0,"visible":true,"width":32,"x":640,"y":32},{"class":"Item","height":32,"id":12,"name":"Fire_Spell","rotation":0,"visible":true,"width":32,"x":704,"y":32},{"class":"Item","height":32,"id":13,"name":"Iron_Armor","rotation":0,"visible":true,"width":32,"x":768,"y":32},{"class":"Item","height":32,"id":14,"name":"Katana","rotation":0,"visible":true,"width":32,"x":832,"y":32},{"class":"NPC","ellipse":true,"height":32,"id":15,"name":"Merchant","rotation":0,"visible":true,"width":32,"x":768,"y":64},{"class":"Item","height":32,"id":16,"name":"Club","rotation":0,"visible":true,"width":32,"x":416,"y":32},{"class":"Enemy","ellipse":true,"height":32,"id":17,"name":"Zombie","rotation":0,"visible":true,"width":32,"x":192,"y":32},{"class":"Enemy","ellipse":true,"height":32,"id":18,"name":"Zombie","rotation":0,"visible":true,"width":32,"x":32,"y":64},{"class":"Enemy","ellipse":true,"height":32,"id":19,"name":"Zombie","rotation":0,"visible":true,"width":32,"x":224,"y":256}],"opacity":1,"type":"objectgroup","visible":true,"x":0,"y":0}],"nextlayerid":4,"nextobjectid":21,"orientation":"orthogonal","properties":[{"name":"audio","type":"string","value":"town"},{"name":"finishRules","type":"string","value":"[]"},{"name":"start","type":"string","value":"[14, 6]"},{"name":"startRules","type":"string","value":"[]"}],"renderorder":"left-up","tiledversion":"1.9.2","tileheight":32,"tilesets":[{"columns":8,"firstgid":1,"image":"../../assets/tilesheet.png","imageheight":256,"imagewidth":256,"margin":0,"name":"tilesheet","spacing":0,"tilecount":64,"tileheight":32,"tilewidth":32}],"tilewidth":32,"type":"map","version":"1.9","width":28,"name":"map1"},{"compressionlevel":-1,"height":11,"infinite":false,"layers":[{"data":[29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,27,27,28,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,29,29,35,35,36,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,29,29,35,35,36,25,25,29,29,45,29,25,29,45,29,29,25,25,25,25,25,29,29,41,35,36,25,29,29,29,25,25,25,25,25,29,29,29,25,25,25,33,29,29,35,35,36,25,25,29,29,45,29,29,29,45,29,29,25,25,25,25,25,29,29,35,35,36,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,29,29,43,43,44,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29],"height":11,"id":1,"name":"TileLayer","opacity":1,"type":"tilelayer","visible":true,"width":21,"x":0,"y":0},{"data":[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,64,0,0,0,0,0,64,64,64,64,0,64,64,64,64,0,0,0,0,0,64,64,0,0,0,0,64,64,64,0,0,0,0,0,64,64,64,0,0,0,0,64,64,0,0,0,0,0,64,64,64,64,64,64,64,64,64,0,0,0,0,0,64,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],"height":11,"id":2,"name":"Walls","opacity":1,"type":"tilelayer","visible":false,"width":21,"x":0,"y":0},{"draworder":"topdown","id":3,"name":"ObjectLayer","objects":[{"class":"Transition","height":32,"id":3,"name":"_1","properties":[{"name":"transition","type":"string","value":"{ \\"map\\": \\"map1\\", \\"x\\": 2, \\"y\\": 7, \\"followRules\\": true, \\"key\\": null }"}],"rotation":0,"visible":true,"width":32,"x":32,"y":160},{"class":"Transition","height":32,"id":5,"name":"_2","properties":[{"name":"transition","type":"string","value":"{ \\"map\\": \\"map1\\", \\"x\\": 8, \\"y\\": 7, \\"followRules\\": true, \\"key\\": \\"Key\\" }"}],"rotation":0,"visible":true,"width":32,"x":608,"y":160},{"class":"Item","height":32,"id":6,"name":"Key","rotation":0,"visible":true,"width":32,"x":320,"y":160},{"class":"Item","height":32,"id":7,"name":"Iron_Sword","rotation":0,"visible":true,"width":32,"x":32,"y":64},{"class":"Item","height":32,"id":8,"name":"Water_Spell","rotation":0,"visible":true,"width":32,"x":64,"y":64},{"class":"Item","height":32,"id":9,"name":"Iron_Sword","rotation":0,"visible":true,"width":32,"x":32,"y":256},{"class":"Item","height":32,"id":10,"name":"Water_Spell","rotation":0,"visible":true,"width":32,"x":64,"y":256},{"class":"Enemy","ellipse":true,"height":32,"id":12,"name":"Hell-Hound","rotation":0,"visible":true,"width":32,"x":256,"y":160},{"class":"Enemy","ellipse":true,"height":32,"id":13,"name":"Hell-Hound","rotation":0,"visible":true,"width":32,"x":384,"y":160},{"class":"Enemy","ellipse":true,"height":32,"id":14,"name":"Ghost","rotation":0,"visible":true,"width":32,"x":160,"y":64},{"class":"Enemy","ellipse":true,"height":32,"id":15,"name":"Ghost","rotation":0,"visible":true,"width":32,"x":160,"y":256},{"class":"Enemy","ellipse":true,"height":32,"id":16,"name":"Ghost","rotation":0,"visible":true,"width":32,"x":480,"y":64},{"class":"Enemy","ellipse":true,"height":32,"id":17,"name":"Ghost","rotation":0,"visible":true,"width":32,"x":480,"y":256}],"opacity":1,"type":"objectgroup","visible":true,"x":0,"y":0}],"nextlayerid":4,"nextobjectid":18,"orientation":"orthogonal","properties":[{"name":"audio","type":"string","value":"dungeon"},{"name":"finishRules","type":"string","value":"[]"},{"name":"startRules","type":"string","value":"[]"}],"renderorder":"left-up","tiledversion":"1.9.2","tileheight":32,"tilesets":[{"columns":8,"firstgid":1,"image":"../../assets/tilesheet.png","imageheight":256,"imagewidth":256,"margin":0,"name":"tilesheet","spacing":0,"tilecount":64,"tileheight":32,"tilewidth":32}],"tilewidth":32,"type":"map","version":"1.9","width":21,"name":"map2"},{"compressionlevel":-1,"height":9,"infinite":false,"layers":[{"data":[5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,1,1,1,1,5,21,13,21,5,5,5,5,5,5,1,2,3,3,4,1,1,1,1,1,1,5,5,5,1,10,11,11,5,1,1,1,5,5,1,5,5,5,5,5,19,5,5,5,5,5,5,5,1,5,5,5,13,21,1,5,11,11,11,12,1,1,1,5,5,5,1,1,1,5,11,17,11,12,1,1,1,5,5,5,1,1,1,5,11,11,11,12,1,1,1,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],"height":9,"id":1,"name":"TileLayer","opacity":1,"type":"tilelayer","visible":true,"width":14,"x":0,"y":0},{"data":[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,0,0,0,0,64,64,0,64,64,64,64,64,64,64,0,0,0,0,0,0,0,0,0,0,0,64,64,64,0,0,0,0,64,0,0,0,64,64,0,64,64,64,64,64,0,64,64,64,64,64,64,64,0,64,64,64,0,64,0,64,0,0,0,0,0,0,0,64,64,64,0,0,0,64,0,0,0,0,0,0,0,64,64,64,0,0,0,64,0,0,0,0,0,0,0,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],"height":9,"id":2,"name":"Walls","opacity":1,"type":"tilelayer","visible":false,"width":14,"x":0,"y":0},{"draworder":"topdown","id":3,"name":"ObjectLayer","objects":[{"class":"Transition","height":32,"id":1,"name":"_1","properties":[{"name":"transition","type":"string","value":"{ \\"map\\": \\"map1\\", \\"x\\": 23, \\"y\\": 5, \\"followRules\\": false, \\"key\\": null }"}],"rotation":0,"visible":true,"width":32,"x":32,"y":160},{"class":"Transition","height":32,"id":2,"name":"_2","properties":[{"name":"transition","type":"string","value":"{ \\"map\\": \\"map4\\", \\"x\\": 7, \\"y\\": 2, \\"followRules\\": true, \\"key\\": \\"Golden_Key\\" }"}],"rotation":0,"visible":true,"width":32,"x":224,"y":32},{"class":"Transition","height":32,"id":3,"name":"_3","properties":[{"name":"transition","type":"string","value":"{ \\"map\\": \\"map4\\", \\"x\\": 6, \\"y\\": 6, \\"followRules\\": false, \\"key\\": null }"}],"rotation":0,"visible":true,"width":32,"x":192,"y":192},{"class":"Item","height":32,"id":4,"name":"Mana_Potion","rotation":0,"visible":true,"width":32,"x":64,"y":224},{"class":"Item","height":32,"id":5,"name":"Stamina_Potion","rotation":0,"visible":true,"width":32,"x":96,"y":224},{"class":"Enemy","ellipse":true,"height":32,"id":6,"name":"Ghost","rotation":0,"visible":true,"width":32,"x":96,"y":32},{"class":"Enemy","ellipse":true,"height":32,"id":7,"name":"Zombie","rotation":0,"visible":true,"width":32,"x":128,"y":64},{"class":"Enemy","ellipse":true,"height":32,"id":8,"name":"Hell-Hound","rotation":0,"visible":true,"width":32,"x":320,"y":64},{"class":"Enemy","ellipse":true,"height":32,"id":9,"name":"Zombie","rotation":0,"visible":true,"width":32,"x":352,"y":128},{"class":"Enemy","ellipse":true,"height":32,"id":10,"name":"Knight","rotation":0,"visible":true,"width":32,"x":256,"y":192}],"opacity":1,"type":"objectgroup","visible":true,"x":0,"y":0}],"nextlayerid":4,"nextobjectid":11,"orientation":"orthogonal","properties":[{"name":"audio","type":"string","value":"town"},{"name":"finishRules","type":"string","value":"[]"},{"name":"startRules","type":"string","value":"[]"}],"renderorder":"left-up","tiledversion":"1.9.2","tileheight":32,"tilesets":[{"columns":8,"firstgid":1,"image":"../../assets/tilesheet.png","imageheight":256,"imagewidth":256,"margin":0,"name":"tilesheet","spacing":0,"tilecount":64,"tileheight":32,"tilewidth":32}],"tilewidth":32,"type":"map","version":"1.9","width":14,"name":"map3"},{"compressionlevel":-1,"height":9,"infinite":false,"layers":[{"data":[29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,25,25,25,25,29,45,37,45,29,29,29,29,29,29,25,26,27,27,28,25,25,25,29,29,29,29,29,29,25,34,35,35,29,25,25,25,29,29,29,29,29,29,29,29,43,29,29,29,29,29,29,29,45,29,29,29,29,45,25,29,35,35,35,36,25,25,25,29,29,29,25,25,25,29,35,41,35,36,25,25,25,29,29,29,25,33,25,29,35,35,35,36,25,25,25,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29],"height":9,"id":1,"name":"TileLayer","opacity":1,"type":"tilelayer","visible":true,"width":14,"x":0,"y":0},{"data":[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,0,0,0,0,64,64,0,64,64,64,64,64,64,64,0,0,0,0,0,0,0,0,64,64,64,64,64,64,0,0,0,0,64,0,0,0,64,64,64,64,64,64,64,64,0,64,64,64,64,64,64,64,64,64,64,64,64,64,0,64,0,0,0,0,0,0,0,64,64,64,0,0,0,64,0,0,0,0,0,0,0,64,64,64,0,0,0,64,0,0,0,0,0,0,0,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],"height":9,"id":2,"name":"Walls","opacity":1,"type":"tilelayer","visible":false,"width":14,"x":0,"y":0},{"draworder":"topdown","id":3,"name":"ObjectLayer","objects":[{"class":"Transition","height":32,"id":1,"name":"_1","properties":[{"name":"transition","type":"string","value":"{ \\"map\\": \\"map3\\", \\"x\\": 6, \\"y\\": 6, \\"followRules\\": false, \\"key\\": null }"}],"rotation":0,"visible":true,"width":32,"x":192,"y":192},{"class":"Transition","height":32,"id":2,"name":"_2","rotation":0,"visible":true,"width":32,"x":64,"y":224},{"class":"Item","height":32,"id":3,"name":"Golden_Key","rotation":0,"visible":true,"width":32,"x":320,"y":192},{"class":"Enemy","ellipse":true,"height":32,"id":4,"name":"Knight","rotation":0,"visible":true,"width":32,"x":256,"y":160},{"class":"Enemy","ellipse":true,"height":32,"id":5,"name":"Knight","rotation":0,"visible":true,"width":32,"x":256,"y":224},{"class":"Enemy","ellipse":true,"height":32,"id":6,"name":"Majin","rotation":0,"visible":true,"width":32,"x":64,"y":64}],"opacity":1,"type":"objectgroup","visible":true,"x":0,"y":0}],"nextlayerid":4,"nextobjectid":7,"orientation":"orthogonal","properties":[{"name":"audio","type":"string","value":"dungeon"},{"name":"finishRules","type":"string","value":"[\\"finish.entity.Majin.kill..\\"]"},{"name":"startRules","type":"string","value":"[\\"start.entity.player.hp.1000.\\",\\"start.entity.player.mp.100.\\",\\"start.entity.player.sp.100.\\"]"}],"renderorder":"left-up","tiledversion":"1.9.2","tileheight":32,"tilesets":[{"columns":8,"firstgid":1,"image":"../../assets/tilesheet.png","imageheight":256,"imagewidth":256,"margin":0,"name":"tilesheet","spacing":0,"tilecount":64,"tileheight":32,"tilewidth":32}],"tilewidth":32,"type":"map","version":"1.9","width":14,"name":"map4"}]');var U=function(){function t(){this.field=new W,this.image=new Image,this.currentMap="map1"}return t.prototype.readTiles=function(){var t=this;return this.image=new Image,new Promise((function(e,n){t.image.onload=function(){return e()},t.image.src="assets/tilesheet.png"}))},t.prototype.loadMap=function(t,e){void 0===t&&(t=this.currentMap);var n=gt.getInstance();n.clearMap(),this.currentMap=t,this.parseMap(t,n.getStorage()),n.setPlayer(e),A()},t.prototype.parseMap=function(t,e,n){var i,o=this;void 0===n&&(n=!1),this.field=new W;var s=j.find((function(e){return e.name===t}));this.setSize(s.width,s.height);var a=s.layers.find((function(t){return"ObjectLayer"===t.name})).objects;n||(a.filter((function(t){return"Enemy"===t.class})).forEach((function(t){o.setEntity(e.getEnemies().get(t.name).clone(),new h(t.x/s.tilewidth,t.y/s.tilewidth))})),a.filter((function(t){return"NPC"===t.class})).forEach((function(t){o.setEntity(e.getNPCs().get(t.name).clone(),new h(t.x/s.tilewidth,t.y/s.tilewidth))})),a.filter((function(t){return"Item"===t.class})).forEach((function(t){o.setItem(e.getItems().get(t.name).clone(),new h(t.x/s.tilewidth,t.y/s.tilewidth))}))),a.filter((function(t){return"Transition"===t.class})).forEach((function(t){var e=t.properties;o.setFinish(new h(t.x/s.tilewidth,t.y/s.tilewidth),e?JSON.parse(e.find((function(t){return"transition"===t.name})).value):null)})),s.layers.find((function(t){return"Walls"===t.name})).data.forEach((function(t,e){t&&o.toggleCellAccessibility(new h(e%s.width,Math.floor(e/s.width)))}));var r=null===(i=s.properties.find((function(t){return"start"===t.name})))||void 0===i?void 0:i.value;if(r){var c=JSON.parse(r);this.setStart(new h(c[0],c[1]))}gt.getInstance().clearRules(!0),gt.getInstance().clearRules(!1);var p=JSON.parse(s.properties.find((function(t){return"startRules"===t.name})).value),u=JSON.parse(s.properties.find((function(t){return"finishRules"===t.name})).value);p.forEach((function(t){return T(t.split("."))})),u.forEach((function(t){return T(t.split("."))}));var l=s.layers.find((function(t){return"TileLayer"===t.name})).data,d=this.image.width/s.tilewidth,g=this.image.height/s.tilewidth;l.forEach((function(t,e){o.setTilePos(new h(e%s.width,Math.floor(e/s.width)),new h((t-1)%d,Math.floor((t-1)/g)))}));var y=s.properties.find((function(t){return"audio"===t.name})).value;gt.getInstance().getAudioManager().setBackground(y)},t.prototype.getField=function(){return this.field},t.prototype.getCurrentMap=function(){return this.currentMap},t.prototype.getTileSheet=function(){return this.image},t.prototype.setSize=function(t,e){this.field=new W(t,e)},t.prototype.toggleCellAccessibility=function(t){this.field.cellAt(t).isAccessible()&&this.field.cellAt(t).toggleAccessibility()},t.prototype.setStart=function(t){for(var e=0;e<this.field.getWidth();e++)for(var n=0;n<this.field.getHeigth();n++)this.field.cellAt(t).isStart()&&this.field.cellAt(t).setState(D.normal);this.field.cellAt(t).setState(D.start)},t.prototype.setFinish=function(t,e){this.field.cellAt(t).setState(D.finish),e&&this.field.cellAt(t).setTransition(e)},t.prototype.setEntity=function(t,e){this.field.cellAt(e).setEntity(t),t.setPos(e),gt.getInstance().addEntity(t)},t.prototype.setItem=function(t,e){this.field.cellAt(e).setItem(t),t.setPos(e),gt.getInstance().addItem(t)},t.prototype.canItemBeSet=function(t){return this.field.isInField(t)&&!this.field.cellAt(t).hasItem()},t.prototype.canEntityBeSet=function(t){return this.field.isInField(t)&&this.field.cellAt(t).isFree()},t.prototype.setTilePos=function(t,e){this.field.cellAt(t).setTilePos(e)},t}();const G=JSON.parse('[{"name":"Mana_Potion","x":128,"y":384,"width":32,"height":32},{"name":"Merchant","x":256,"y":0,"width":128,"height":64},{"name":"Player","x":0,"y":0,"width":128,"height":96},{"name":"Stamina_Potion","x":128,"y":416,"width":32,"height":32},{"name":"Water_Spell.anim","x":0,"y":96,"width":128,"height":96},{"name":"Water_Spell","x":160,"y":416,"width":32,"height":32},{"name":"Zombie","x":256,"y":64,"width":128,"height":64},{"name":"Club.anim","x":128,"y":0,"width":128,"height":96},{"name":"Club","x":192,"y":416,"width":32,"height":32},{"name":"Fire_Spell.anim","x":128,"y":96,"width":128,"height":96},{"name":"Fire_Spell","x":224,"y":416,"width":32,"height":32},{"name":"Ghost","x":256,"y":128,"width":128,"height":64},{"name":"Golden_Key","x":256,"y":416,"width":32,"height":32},{"name":"Guide","x":256,"y":192,"width":128,"height":64},{"name":"Healing_Potion","x":288,"y":416,"width":32,"height":32},{"name":"Hell-Hound","x":256,"y":256,"width":128,"height":64},{"name":"Iron_Armor.anim","x":0,"y":192,"width":128,"height":96},{"name":"Iron_Armor","x":320,"y":416,"width":32,"height":32},{"name":"Iron_Sword.anim","x":128,"y":192,"width":128,"height":96},{"name":"Iron_Sword","x":352,"y":416,"width":32,"height":32},{"name":"Katana.anim","x":0,"y":288,"width":128,"height":96},{"name":"Katana","x":160,"y":384,"width":32,"height":32},{"name":"Key","x":192,"y":384,"width":32,"height":32},{"name":"Knight","x":256,"y":320,"width":128,"height":64},{"name":"Leather_Armor.anim","x":128,"y":288,"width":128,"height":96},{"name":"Leather_Armor","x":224,"y":384,"width":32,"height":32},{"name":"Majin","x":0,"y":384,"width":128,"height":64}]');var Y=32,V=function(){function t(){this.image=new Image,this.spriteMap=new Map}return t.prototype.readSprites=function(){var t=this;return new Promise((function(e,n){t.image.onload=function(){return e()},t.image.src="assets/spritesheet.png",G.forEach((function(e){t.spriteMap.set(e.name,{pos:new h(e.x/Y,e.y/Y),offset:new h(0,0)})}))}))},t.prototype.getSprite=function(t){return this.spriteMap.get(t)},t.prototype.setPlayerSprite=function(t){t.setSprite(this.spriteMap.get("Player"))},t.prototype.getSpriteSheet=function(){return this.image},t}(),z=function(){function t(){this.animState={secondAnimFrame:!1,playerResting:!1,playerDropping:!1,playerDrinking:!1,scale:2},this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d"),this.scaledSpriteSize=this.animState.scale*Y,this.spriteManager=gt.getInstance().getSpriteManager(),this.spriteSheet=this.spriteManager.getSpriteSheet(),this.tilesheet=gt.getInstance().getMapManager().getTileSheet()}return t.prototype.drawItem=function(t,e,n){if(this.drawSprite(t.getSprite(),e,n),t.getMoneyCost()){var i="".concat(t.getMoneyCost(),"$");this.ctx.font="".concat(Math.floor(this.scaledSpriteSize/4),"px PixeloidSans"),this.ctx.fillStyle="white",this.ctx.fillText(i,e+2,n+this.scaledSpriteSize-2,this.scaledSpriteSize-4)}},t.prototype.drawEntity=function(t,e,n){var i=t.getSprite();if(i.offset=new h(+t.getDir()%4,+this.animState.secondAnimFrame),this.drawSprite(i,e,n),t instanceof w&&t.getHP()<t.getmaxHP()){var o=2*this.animState.scale,s=3*this.animState.scale,a=Math.ceil(this.scaledSpriteSize/16),r=this.scaledSpriteSize-2*o,c=r*t.getHP()/t.getmaxHP();this.ctx.fillStyle="green",this.ctx.fillRect(e+o,n+this.scaledSpriteSize-a-s,c,a),this.ctx.fillStyle="red",this.ctx.fillRect(e+o+c,n+this.scaledSpriteSize-a-s,r-c,a)}},t.prototype.drawPlayer=function(t,e){var n,i,o,s=gt.getInstance().getPlayer(),a=s.getSprite();this.animState.playerResting?a.offset=new h(0,2):this.animState.playerDropping?a.offset=new h(1,2):this.animState.playerDrinking?a.offset=new h(2,2):a.offset=new h(+s.getDir()%4,+this.animState.secondAnimFrame),this.drawSprite(a,t,e),s.hasArmor()&&(s.getArmor().getUSprite().offset=a.offset,this.drawSprite(null===(n=s.getArmor())||void 0===n?void 0:n.getUSprite(),t,e)),this.animState.playerResting||this.animState.playerDropping||this.animState.playerDrinking||(s.hasWeapon()&&(s.getWeapon().getUSprite().offset=a.offset,this.drawSprite(null===(i=s.getWeapon())||void 0===i?void 0:i.getUSprite(),t,e)),s.hasSpell()&&(s.getSpell().getUSprite().offset=a.offset,this.drawSprite(null===(o=s.getSpell())||void 0===o?void 0:o.getUSprite(),t,e)))},t.prototype.drawSprite=function(t,e,n){this.ctx.drawImage(this.spriteSheet,(t.pos.x+t.offset.x)*Y,(t.pos.y+t.offset.y)*Y,Y,Y,e,n,Y*this.animState.scale,Y*this.animState.scale)},t.prototype.drawTile=function(t,e,n){this.ctx.drawImage(this.tilesheet,t.x*Y,t.y*Y,Y,Y,e,n,Y*this.animState.scale,Y*this.animState.scale)},t.prototype.noSmoothing=function(){this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.mozImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1},t.prototype.drawField=function(t){var e,n;this.noSmoothing();for(var i=gt.getInstance().getPlayer().getPos(),o=Math.round(this.canvas.width/2-this.scaledSpriteSize*(.5+i.x)),s=Math.round(this.canvas.height/2-this.scaledSpriteSize*(.5+i.y)),a=0;a<t.getWidth();a++)for(var r=0;r<t.getHeigth();r++){e=a*this.scaledSpriteSize+o,n=r*this.scaledSpriteSize+s;var c=new h(a,r);this.drawTile(t.cellAt(c).getTilePos(),e,n),t.cellAt(c).hasItem()&&this.drawItem(t.cellAt(c).getItem(),e,n),t.cellAt(c).isEntityEnemy()||t.cellAt(c).isEntityNPC()?this.drawEntity(t.cellAt(c).getEntity(),e,n):t.cellAt(c).isEntityPlayer()&&this.drawPlayer(e,n)}},t.prototype.drawInfo=function(){var t,e,n,i,o=this;this.ctx.font="22px Pixeboy",this.ctx.fillStyle="white";var s,a=gt.getInstance().getPlayer();s="HP: ".concat(a.getHP(),"\tSP: ").concat(a.getSP(),"\tMP: ").concat(a.getMP()),this.ctx.fillText(s,10,25),s="Weapon: ".concat(a.hasWeapon()?null===(t=a.getWeapon())||void 0===t?void 0:t.getName().replace("_"," "):"None"),this.ctx.fillText(s,10,50),s="Spell: ".concat(a.hasSpell()?null===(e=a.getSpell())||void 0===e?void 0:e.getName().replace("_"," "):"None"),this.ctx.fillText(s,10,75),s="Armor: ".concat(a.hasArmor()?null===(n=a.getArmor())||void 0===n?void 0:n.getName().replace("_"," "):"None"),this.ctx.fillText(s,10,100),s="Potion: ".concat(a.hasPotion()?null===(i=a.getPotion())||void 0===i?void 0:i.getName().replace("_"," "):"None"),this.ctx.fillText(s,10,125),s="Money: ".concat(a.getMoney()),this.ctx.fillText(s,10,150),s="Score: ".concat(a.getScore()),this.ctx.fillText(s,10,175);var h,c=220,p=0;(h=[],gt.getInstance().getRules(!1).forEach((function(t){var e="";switch(t.condition()){case r.COUNT:e="No more than ".concat(t.value()," ").concat("all"==t.name()?"entities":t.name(),"  on the map");break;case r.KILL:e="Kill every  ".concat("all"==t.name()?"entity":t.name(),"  on the map")}h.push(e)})),h).forEach((function(t){o.ctx.fillText(t,30,c),c+=20,p++})),s="Goals: ".concat(p?"":"None"),this.ctx.fillText(s,10,200)},t.prototype.drawLog=function(){var t=this;this.ctx.font="16px PixeloidSans",this.ctx.fillStyle="white";var e,n=25;gt.getInstance().getEvents().forEach((function(i){e=i.toString().replace("_"," "),t.ctx.fillText(e,t.canvas.width-t.ctx.measureText(e).width-10,n),n+=20}))},t.prototype.drawDialogue=function(){var t=this,e=gt.getInstance().getDialogue();if(e.opened()){var n=Math.ceil(this.canvas.height-200),i=20,o=10;this.ctx.fillStyle="#261705",this.ctx.fillRect(0,n,this.canvas.width,i+2*o);var s=o-8,a=e.getTarget().getName();n+=8,this.ctx.font="".concat(i,"px PixeloidSans"),this.ctx.fillStyle="#b8a288",this.ctx.fillRect(40,n,this.ctx.measureText(a).width+16,i+2*s),n+=s+i-3,this.ctx.fillStyle="#140c02",this.ctx.fillText(a,50,n,this.canvas.width-16),n+=o+3,this.ctx.fillStyle="#b8a288",this.ctx.fillRect(0,n,this.canvas.width,this.canvas.height-n),o=50,n+=30,i=20,this.ctx.font="".concat(i,"px PixeloidSans"),this.ctx.fillStyle="#140c02",this.getLines(e.getText(),this.canvas.width-2*o).forEach((function(e){t.ctx.fillText(e,o,n,t.canvas.width-2*o),n+=i+4}))}},t.prototype.clear=function(){this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)},t.prototype.toggleAnimFrame=function(){this.animState.secondAnimFrame=!this.animState.secondAnimFrame},t.prototype.clearPlayerAction=function(){this.animState.playerResting=!1,this.animState.playerDropping=!1,this.animState.playerDrinking=!1},t.prototype.playerRest=function(){this.animState.playerResting=!0},t.prototype.playerDrop=function(){this.animState.playerDropping=!0},t.prototype.playerDrink=function(){this.animState.playerDrinking=!0},t.prototype.getScale=function(){return this.animState.scale},t.prototype.changeScale=function(t){this.animState.scale=t<1?1:t>5?5:t,this.scaledSpriteSize=this.animState.scale*Y},t.prototype.addResizeListener=function(){var t=this,e=function(){t.canvas.width=window.innerWidth,t.canvas.height=window.innerHeight};e(),window.addEventListener("resize",e,!1)},t.prototype.getLines=function(t,e){for(var n=t.split(" "),i=[],o=n[0],s=1;s<n.length;s++){var a=n[s];this.ctx.measureText(o+" "+a).width<e?o+=" "+a:(i.push(o),o=a)}return i.push(o),i},t}();const Q=JSON.parse('{"UP":"KeyW","DOWN":"KeyS","LEFT":"KeyA","RIGHT":"KeyD","HIT":"KeyZ","CAST":"KeyC","SLEEP":"KeyR","BUFF":"KeyB","PICK_UP":"Space","DROP_W":"KeyU","DROP_S":"KeyI","DROP_A":"KeyO","DROP_P":"KeyP","QSAVE":"BracketLeft","QLOAD":"BracketRight"}');var J;!function(t){t.UP="UP",t.DOWN="DOWN",t.LEFT="LEFT",t.RIGHT="RIGHT",t.HIT="HIT",t.CAST="CAST",t.SLEEP="SLEEP",t.BUFF="BUFF",t.PICK_UP="PICK_UP",t.DROP_W="DROP_W",t.DROP_S="DROP_S",t.DROP_A="DROP_A",t.DROP_P="DROP_P",t.QSAVE="QSAVE",t.QLOAD="QLOAD",t.MOVE="MOVE",t.END="END"}(J||(J={}));var q=function(){function t(){var t=this;this.controls=Q,this.action=null,this.dir=null,this.pressed=new Set,this.currentlyPressed=new Set,this.actionGiven=!1,document.addEventListener("keydown",(function(e){return t.readInput(e)})),document.addEventListener("keyup",(function(e){return t.readInput(e,!1)})),document.getElementById("canvas").onwheel=function(e){return t.readInput(e)},this.initControlsList()}return t.prototype.readInput=function(t,e){if(void 0===e&&(e=!0),gt.getInstance().isActive())if(t instanceof KeyboardEvent){var n=t.code;if(e){if(t.ctrlKey||t.altKey)return;this.pressed.add(n),this.currentlyPressed.add(n)}else this.currentlyPressed.delete(n),this.currentlyPressed.size||this.processInput()}else t instanceof WheelEvent&&(t.preventDefault(),t.stopPropagation(),gt.getInstance().changeScale(-t.deltaY/50))},t.prototype.isKeyPressed=function(t){return this.pressed.has(this.controls[t])},t.prototype.processInput=function(){var t=gt.getInstance().getMenu(),e=gt.getInstance().getDialogue();if(t.opened())this.pressed.has("Escape")?t.processEscape():this.pressed.has("Enter")?this.click(t.getFocusedButton()):this.pressed.has("ArrowUp")||this.pressed.has("ArrowLeft")?t.prevButton():(this.pressed.has("ArrowDown")||this.pressed.has("ArrowRight"))&&t.nextButton();else if(e.opened())this.pressed.has("Escape")||!e.shouldProceed()?e.close():e.next();else{this.actionGiven=!0;var i=this.isKeyPressed(J.UP),o=this.isKeyPressed(J.RIGHT),s=this.isKeyPressed(J.DOWN),a=this.isKeyPressed(J.LEFT);this.dir=function(t,e,i,o){return t&&!i?o&&!e?n.NW:e&&!o?n.NE:n.N:i&&!t?o&&!e?n.SW:e&&!o?n.SE:n.S:o&&!e?n.W:e&&!o?n.E:null}(i,o,s,a),null!==this.dir?this.isKeyPressed(J.HIT)?this.action=J.HIT:this.isKeyPressed(J.CAST)?this.action=J.CAST:this.action=J.MOVE:this.isKeyPressed(J.SLEEP)?this.action=J.SLEEP:this.isKeyPressed(J.PICK_UP)?this.action=J.PICK_UP:this.isKeyPressed(J.BUFF)?this.action=J.BUFF:this.isKeyPressed(J.DROP_W)?this.action=J.DROP_W:this.isKeyPressed(J.DROP_S)?this.action=J.DROP_S:this.isKeyPressed(J.DROP_A)?this.action=J.DROP_A:this.isKeyPressed(J.DROP_P)?this.action=J.DROP_P:this.isKeyPressed(J.QSAVE)?this.action=J.QSAVE:this.isKeyPressed(J.QLOAD)?this.action=J.QLOAD:(this.pressed.has("Escape")&&t.toggle(),this.actionGiven=!1)}this.pressed.clear()},t.prototype.getAction=function(){return this.action},t.prototype.getDirection=function(){return this.dir},t.prototype.clearActions=function(){this.actionGiven=!1},t.prototype.hasAction=function(){return this.actionGiven},t.prototype.getActionControls=function(t){return this.controls[t]},t.prototype.initControlsList=function(){var t=[];t.push("Move: ".concat(this.getActionControls(J.UP),", ").concat(this.getActionControls(J.LEFT),", ").concat(this.getActionControls(J.DOWN),", ").concat(this.getActionControls(J.RIGHT))),t.push("Hit/Talk: ".concat(this.getActionControls(J.HIT)," + move")),t.push("Cast spell: ".concat(this.getActionControls(J.CAST)," + move")),t.push("Sleep: ".concat(this.getActionControls(J.SLEEP))),t.push("Drink potion: ".concat(this.getActionControls(J.BUFF))),t.push("Pick up: ".concat(this.getActionControls(J.PICK_UP))),t.push("Drop weapon: ".concat(this.getActionControls(J.DROP_W))),t.push("Drop spell: ".concat(this.getActionControls(J.DROP_S))),t.push("Drop armor: ".concat(this.getActionControls(J.DROP_A))),t.push("Drop potion: ".concat(this.getActionControls(J.DROP_P))),t.push("Quick save: ".concat(this.getActionControls(J.QSAVE))),t.push("Quick load: ".concat(this.getActionControls(J.QLOAD))),t.forEach((function(t){var e=document.createElement("p");e.innerHTML=t,document.getElementById("controls-list").appendChild(e)}))},t.prototype.click=function(t){var e=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});t.dispatchEvent(e)},t}(),Z=function(){function t(){}return t.prototype.save=function(t){try{var e={map:"",entityCount:0,entities:[],itemCount:0,items:[],player:{x:0,y:0,hp:0,sp:0,mp:0,money:0,score:0,weapon:{name:"",dur:0,money:0},spell:{name:"",dur:0,money:0},armor:{name:"",dur:0,money:0},potion:{name:"",dur:0,money:0},keyItems:[]}},n=gt.getInstance(),i=n.getEntities(),o=n.getItems(),s=n.getPlayer();e.map=gt.getInstance().getMapManager().getCurrentMap();var a,r=0;return i.forEach((function(t){r++,a=t.getPos(),e.entities.push({name:t.getName(),x:a.x,y:a.y,hp:t instanceof b?t.getPhraseIndex():t.getHP()})})),e.entityCount=r,r=0,o.forEach((function(t){r++,a=t.getPos(),e.items.push({name:t.getName(),x:a.x,y:a.y,dur:t.getDur(),money:t.getMoneyCost()})})),e.itemCount=r,a=s.getPos(),e.player={x:a.x,y:a.y,hp:s.getHP(),sp:s.getSP(),mp:s.getMP(),money:s.getMoney(),score:s.getScore(),weapon:s.hasWeapon()?{name:s.getWeapon().getName(),dur:s.getWeapon().getDur(),money:s.getWeapon().getMoneyCost()}:{name:"None",dur:0,money:0},spell:s.hasSpell()?{name:s.getSpell().getName(),dur:s.getSpell().getDur(),money:s.getSpell().getMoneyCost()}:{name:"None",dur:0,money:0},armor:s.hasArmor()?{name:s.getArmor().getName(),dur:s.getArmor().getDur(),money:s.getArmor().getMoneyCost()}:{name:"None",dur:0,money:0},potion:s.hasPotion()?{name:s.getPotion().getName(),dur:s.getPotion().getDur(),money:s.getPotion().getMoneyCost()}:{name:"None",dur:0,money:0},keyItems:s.getKeyItems()},localStorage.setItem("save ".concat(t),JSON.stringify(e)),n.msg("Game saved\n"),!0}catch(t){var h;return h=t instanceof Error?t.message:String(t),gt.getInstance().msg(h),!1}},t.prototype.load=function(t){try{var e=localStorage.getItem("save ".concat(t));if(!e)throw new Error("Error: Save not found");var n=JSON.parse(e),i=gt.getInstance(),o=i.getStorage(),s=gt.getInstance().getMapManager();s.parseMap(n.map,o,!0);var a,c=[],p=[],u=void 0;if(n.entities.forEach((function(t){var e;if(o.checkEnemy(t.name))(e=o.getEnemies().get(t.name).clone()).changeStat(r.HP,t.hp);else{if(!o.checkNPC(t.name))throw new Error("Entity ".concat(t.name," not found"));(e=o.getNPCs().get(t.name).clone()).setPhraseIndex(t.hp)}if(a=new h(t.x,t.y),!s.canEntityBeSet(a))throw new Error("Error while placing an entity");e.setPos(a),c.push(e),s.setEntity(e,a)})),n.items.forEach((function(t){if(!o.checkItem(t.name))throw new Error("Error: Itme ".concat(t.name," not found"));var e=o.getItems().get(t.name).clone();if(e.changeStat(r.DUR,t.dur),e.changeStat(r.PRICE,t.money),a=new h(t.x,t.y),!s.canItemBeSet(a))throw new Error("Error while placing an item");e.setPos(a),p.push(e),s.setItem(e,a)})),a=new h(n.player.x,n.player.y),!s.canEntityBeSet(a))throw new Error("Error while placing a player");(u=i.getPlayer().clone()).setPos(a),u.changeStat(r.HP,n.player.hp),u.changeStat(r.MP,n.player.mp),u.changeStat(r.SP,n.player.sp),u.changeStat(r.MONEY,n.player.money),u.changeStat(r.SCORE,n.player.score);var l=n.player.weapon;if("None"!=l.name){if(!o.checkItem(l.name))throw new Error("Error: Item ".concat(l.name," not found"));var d=o.getItems().get(l.name).clone();d.changeStat(r.DUR,l.dur),d.changeStat(r.PRICE,l.money),u.setWeapon(d)}if("None"!=(l=n.player.spell).name){if(!o.checkItem(l.name))throw new Error("Error: Itme ".concat(l.name," not found"));var g=o.getItems().get(l.name).clone();g.changeStat(r.DUR,l.dur),g.changeStat(r.PRICE,l.money),u.setSpell(g)}if("None"!=(l=n.player.armor).name){if(!o.checkItem(l.name))throw new Error("Error: Itme ".concat(l.name," not found"));var y=o.getItems().get(l.name).clone();y.changeStat(r.DUR,l.dur),y.changeStat(r.PRICE,l.money),u.setArmor(y)}if("None"!=(l=n.player.potion).name){if(!o.checkItem(l.name))throw new Error("Error: Itme ".concat(l.name," not found"));var m=o.getItems().get(l.name).clone();m.changeStat(r.DUR,l.dur),m.changeStat(r.PRICE,l.money),u.setPotion(m)}return u.setKeyItems(n.player.keyItems),i.setObjects(c,p,u),i.msg("Save ".concat(t," loaded\n")),!0}catch(t){var f;return f=t instanceof Error?t.message:String(t),gt.getInstance().msg(f),!1}},t}(),X=new h(-1,-1),$=function(){function t(t){this.entity=t,this.posFromGuarding=X}return t.prototype.execute=function(){var t=this.entity.getPos();this.posFromGuarding==X&&(this.posFromGuarding=t);var e=gt.getInstance().getPlayer();if(!u(e.getPos(),t)||this.entity instanceof b){var n=c(t,l());u(n,this.posFromGuarding)&&this.entity.movePos(n)}else this.entity.hitEntity(e)},t.prototype.clone=function(e){return new t(e)},t}(),tt=function(){function t(t){this.entity=t}return t.prototype.execute=function(){if(this.entity instanceof b)this.entity.move(l());else{var t=this.entity.getPos(),e=gt.getInstance().getPlayer();if(u(e.getPos(),t))this.entity.hitEntity(e);else{var n=it(2,t,e.getPos());n?this.entity.movePos(n):this.entity.move(l())}}},t.prototype.clone=function(e){return new t(e)},t}(),et=function(){function t(t){this.entity=t}return t.prototype.execute=function(){var t=this.entity.getPos(),e=gt.getInstance().getPlayer();if(!u(e.getPos(),t)||this.entity instanceof b){var n=it(10,t,e.getPos());n?this.entity.movePos(n):this.entity.move(l())}else this.entity.hitEntity(e)},t.prototype.clone=function(e){return new t(e)},t}(),nt=function(){function t(t){this.entity=t,this.dir=n.N}return t.prototype.execute=function(){var t=this.entity.getPos(),e=gt.getInstance().getPlayer();if(!u(e.getPos(),t)||this.entity instanceof b){for(var n=gt.getInstance().getMapManager().getField(),i=0;i<4;i++){var o=c(t,this.dir);if(!n.isInField(o)||n.cellAt(o).isFree())break;this.dir=(this.dir+1)%4}this.entity.move(this.dir)}else this.entity.hitEntity(e)},t.prototype.clone=function(e){return new t(e)},t}();function it(t,e,n){var i,o,s,a=[],r=new Map,h=gt.getInstance().getMapManager().getField(),p=e,u=0;for(r.set(p,X);(a.length>0||!u)&&!p.equals(n)&&u<=t;){for(var l=0;l<8;l++)s=c(p,l),h.isInField(s)&&(h.cellAt(s).isFree()||s.equals(n))&&!ot(r,s)&&(r.set(s,p),a.push(s));for(u=0,s=p=a.shift();s=r.get(s),u++,!(null===(i=r.get(s))||void 0===i?void 0:i.equals(X)););}if(!p.equals(n))return null;for(;p=r.get(p),!(null===(o=r.get(r.get(p)))||void 0===o?void 0:o.equals(X)););return p}var ot=function(t,e){return Array.from(t.keys()).some((function(t){return t.equals(e)}))};const st=JSON.parse('[{"name":"Zombie","strategy":"wander","hp":100,"def":10,"dam":1,"money":10,"sound":"zombie"},{"name":"Ghost","strategy":"patrol","hp":50,"def":100,"dam":50,"money":10,"sound":"ghost"},{"name":"Hell-Hound","strategy":"hunt","hp":100,"def":10,"dam":10,"money":10,"sound":"hound"},{"name":"Knight","strategy":"guard","hp":100,"def":10,"dam":10,"money":100,"sound":"halt"},{"name":"Majin","strategy":"hunt","hp":1000,"def":20,"dam":50,"money":10000,"sound":"majin"}]');var at=function(){function t(){this.enemy=new w,this.spriteManager=gt.getInstance().getSpriteManager()}return t.prototype.setStrategy=function(t){this.enemy.changeStrategy(t)},t.prototype.setStats=function(t,e,n,i){void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=1),void 0===i&&(i=0),this.enemy=new w(t,e,n,i)},t.prototype.setName=function(t){this.enemy.changeName(t)},t.prototype.setSprite=function(t){this.enemy.setSprite(t)},t.prototype.setSound=function(t){this.enemy.setSound(t)},t.prototype.buildPresetEnemy=function(t){var e=st.find((function(e){return e.name==t}));this.setStats(e.hp,e.def,e.dam,e.money),this.setName(e.name),"guard"==e.strategy?this.setStrategy(new $(this.enemy)):"wander"==e.strategy?this.setStrategy(new tt(this.enemy)):"hunt"==e.strategy?this.setStrategy(new et(this.enemy)):"patrol"==e.strategy&&this.setStrategy(new nt(this.enemy)),this.setSprite(this.spriteManager.getSprite(e.name)),this.setSound(e.sound)},t.prototype.getPresetEnemy=function(t){return this.buildPresetEnemy(t),this.getEnemy()},t.prototype.getEnemy=function(){var t=this.enemy;return this.reset(),t},t.prototype.reset=function(){this.enemy=new w},t.prototype.getEnemyList=function(){var t=[];return st.forEach((function(e){t.push(e.name)})),t},t}();const rt=JSON.parse('[{"name":"Iron_Sword","type":"weapon","dam":30,"cost":3,"dur":50,"money":0,"sound":"hitSharp"},{"name":"Katana","type":"weapon","dam":40,"cost":4,"dur":200,"money":50,"sound":"hitSharp"},{"name":"Club","type":"weapon","dam":10,"cost":3,"dur":20,"money":0,"sound":"hitBlunt"},{"name":"Fire_Spell","type":"spell","dam":500,"cost":20,"charges":1,"money":100,"sound":"spell"},{"name":"Water_Spell","type":"spell","dam":15,"cost":5,"charges":1,"money":0,"sound":"spell"},{"name":"Leather_Armor","type":"armor","armor":10,"dur":5,"money":0},{"name":"Iron_Armor","type":"armor","armor":30,"dur":50,"money":50},{"name":"Healing_Potion","type":"potion","pType":"HP","amount":50,"money":10},{"name":"Mana_Potion","type":"potion","pType":"MP","amount":50,"money":0},{"name":"Stamina_Potion","type":"potion","pType":"SP","amount":50,"money":0},{"name":"Key","type":"key","money":0},{"name":"Golden_Key","type":"key","money":100}]');var ht=function(){function t(){this.item=new C,this.spriteManager=gt.getInstance().getSpriteManager()}return t.prototype.newWeapon=function(t,e,n,i){void 0===t&&(t=1),void 0===e&&(e=1),void 0===n&&(n=10),void 0===i&&(i=""),this.item=new C(t,e,n,i)},t.prototype.newSpell=function(t,e,n,i){void 0===t&&(t=1),void 0===e&&(e=1),void 0===n&&(n=1),void 0===i&&(i=""),this.item=new N(t,e,n,i)},t.prototype.newPotion=function(t,e){void 0===t&&(t=I.HP),void 0===e&&(e=50),this.item=new _(t,e)},t.prototype.newArmor=function(t,e){void 0===t&&(t=1),void 0===e&&(e=10),this.item=new R(t,e)},t.prototype.newKeyItem=function(){this.item=new L},t.prototype.setName=function(t){this.item.changeName(t)},t.prototype.setCost=function(t){this.item.setMoneyCost(t)},t.prototype.setSprite=function(t){this.item.setSprite(t)},t.prototype.setUSprite=function(t){this.item.setUSprite(t)},t.prototype.buildPresetItem=function(t){var e=rt.find((function(e){return e.name==t}));if("weapon"==e.type)this.newWeapon(e.dam,e.cost,e.dur,e.sound);else if("spell"==e.type)this.newSpell(e.dam,e.cost,e.charges,e.sound);else if("armor"==e.type)this.newArmor(e.armor,e.dur);else if("potion"==e.type){var n="HP"==e.pType?I.HP:"MP"==e.pType?I.MP:I.SP;this.newPotion(n,e.amount)}else"key"==e.type&&this.newKeyItem();this.setName(e.name),this.setCost(e.money),this.setSprite(this.spriteManager.getSprite(e.name)),"weapon"!=e.type&&"spell"!=e.type&&"armor"!=e.type||this.setUSprite(this.spriteManager.getSprite("".concat(e.name,".anim")))},t.prototype.getPresetItem=function(t){return this.buildPresetItem(t),this.getItem()},t.prototype.getItem=function(){var t=this.item;return this.reset(),t},t.prototype.reset=function(){this.item=new C},t.prototype.getItemList=function(){var t=[];return rt.forEach((function(e){t.push(e.name)})),t},t}();const ct=JSON.parse('[{"name":"Guide","strategy":"guard","talkType":"order","phrases":["*This is not a full game, just a test to see most of game mechanics","The evil Majin terrorize the country and you need to defeat him","To find him you need to enter the door to the right but you need a key for that door","You can find a key if you enter the trapdoor to the left","And be careful: Majin has an army of undead and possessed knights","Good luck"]},{"name":"Merchant","strategy":"guard","talkType":"random","phrases":["You need credits to buy this stuff","You can find free stuff on the ground but it won\'t be so good","Items in the shop require money but they will serve better and longer"]}]');var pt=function(){function t(){this.npc=new b,this.spriteManager=gt.getInstance().getSpriteManager()}return t.prototype.setStrategy=function(t){this.npc.changeStrategy(t)},t.prototype.setTalkType=function(t){this.npc.setTalkType(t)},t.prototype.setPhrases=function(t){this.npc.setPhrases(t)},t.prototype.setName=function(t){this.npc.changeName(t)},t.prototype.setSprite=function(t){this.npc.setSprite(t)},t.prototype.buildPresetNPC=function(t){var e=ct.find((function(e){return e.name==t}));this.setName(e.name),this.setPhrases(e.phrases),"order"==e.talkType?this.setTalkType(S.ORDER):"random"==e.talkType&&this.setTalkType(S.RANDOM),"guard"==e.strategy?this.setStrategy(new $(this.npc)):"wander"==e.strategy?this.setStrategy(new tt(this.npc)):"hunt"==e.strategy?this.setStrategy(new et(this.npc)):"patrol"==e.strategy&&this.setStrategy(new nt(this.npc)),this.setSprite(this.spriteManager.getSprite(e.name))},t.prototype.getPresetNPC=function(t){return this.buildPresetNPC(t),this.getNPC()},t.prototype.getNPC=function(){var t=this.npc;return this.reset(),t},t.prototype.reset=function(){this.npc=new b},t.prototype.getNPCList=function(){var t=[];return ct.forEach((function(e){t.push(e.name)})),t},t}(),ut=function(){function t(){this.enemies=new Map,this.npcs=new Map,this.items=new Map}return t.prototype.readEnemies=function(){var t=this,e=new at;gt.getInstance().msg("Reading enemies: "),e.getEnemyList().forEach((function(n){t.enemies.set(n,e.getPresetEnemy(n)),gt.getInstance().msg("\t".concat(n))})),gt.getInstance().msg("\n")},t.prototype.readNPCs=function(){var t=this,e=new pt;gt.getInstance().msg("Reading NPCs: "),e.getNPCList().forEach((function(n){t.npcs.set(n,e.getPresetNPC(n)),gt.getInstance().msg("\t".concat(n))})),gt.getInstance().msg("\n")},t.prototype.readItems=function(){var t=this,e=new ht;gt.getInstance().msg("Reading items: "),e.getItemList().forEach((function(n){t.items.set(n,e.getPresetItem(n)),gt.getInstance().msg("\t".concat(n))})),gt.getInstance().msg("\n")},t.prototype.getEnemies=function(){return this.enemies},t.prototype.getNPCs=function(){return this.npcs},t.prototype.getItems=function(){return this.items},t.prototype.checkEnemy=function(t){return this.enemies.has(t)},t.prototype.checkNPC=function(t){return this.npcs.has(t)},t.prototype.checkItem=function(t){return this.items.has(t)},t}(),lt=function(){function t(){}return t.load=function(){var t=document.getElementById("tbody"),e=JSON.parse(localStorage.getItem("highscores")||"[]");t.innerHTML="",e.forEach((function(e,n){var i=t.insertRow(),o=i.insertCell(),s=i.insertCell(),a=i.insertCell();o.innerText=(n+1).toString(),s.innerText=e.name,a.innerText=e.score.toString()}))},t.update=function(t){var e=JSON.parse(localStorage.getItem("highscores")||"[]");if(!e.find((function(e){if(e.name===t.name)return e.score=Math.max(+e.score,t.score),!0}))){for(var n=0,i=0,o=e;i<o.length;i++){var s=o[i].score;if(t.score>s)break;n++}(n<10||e.length<10)&&(e.splice(n,0,{name:t.name,score:t.score}),e.length>10&&e.pop())}localStorage.setItem("highscores",JSON.stringify(e))},t}(),dt=function(){function t(){this.mainOpened=!1,this.saveOpened=!1,this.controlsOpened=!1,this.leaderboardOpened=!1,this.audioOpened=!1,this.menu=document.getElementById("game-menu"),this.menuOverlay=document.getElementById("menu-overlay"),this.chosenSave=1,this.focusedIndex=0,this.saveBtnIndex=4,this.mainMenuButtons=this.initMainMenuButtons(),this.saveMenuButtons=this.initSaveMenuButtons(),this.title=document.getElementById("game-menu-title"),this.controlsList=document.getElementById("controls-list"),this.audioSettings=document.getElementById("audioOptions"),this.leaderboard=document.getElementById("leaderboard"),this.setEndButtonListener(),this.game=gt.getInstance(),this.toggle()}return t.prototype.initMainMenuButtons=function(){var t,e=this,n=[];return(t=document.createElement("button")).id="btn-start",t.innerHTML="Start",t.addEventListener("click",(function(t){e.game.setStarted(),e.game.getAudioManager().playAudio("select"),e.toggle()})),n.push(t),(t=document.createElement("button")).id="btn-saves",t.innerHTML="Load",t.addEventListener("click",(function(t){e.saveOpened=!0,e.focusedIndex=1,e.setButtons(),e.game.getAudioManager().playAudio("select")})),n.push(t),(t=document.createElement("button")).id="btn-controls",t.innerHTML="Controls",t.addEventListener("click",(function(t){e.controlsOpened=!0,e.focusedIndex=0,e.setButtons(),e.game.getAudioManager().playAudio("select")})),n.push(t),(t=document.createElement("button")).id="btn-audio",t.innerHTML="Audio",t.addEventListener("click",(function(t){e.audioOpened=!0,e.focusedIndex=0,e.setButtons(),e.game.getAudioManager().playAudio("select")})),n.push(t),(t=document.createElement("button")).id="btn-leaderboard",t.innerHTML="Leaderboard",t.addEventListener("click",(function(t){e.leaderboardOpened=!0,e.focusedIndex=0,e.setButtons(),e.game.getAudioManager().playAudio("select")})),n.push(t),n.forEach((function(t,n){t.addEventListener("mouseover",(function(t){e.setFocused(n),e.setButtons()})),e.menu.appendChild(t),t.hidden=!0})),n},t.prototype.initSaveMenuButtons=function(){for(var t,e=this,n=[],i=function(i){(t=document.createElement("button")).id="btn-save-".concat(i),t.innerHTML="".concat(i?"":"Quick","Save ").concat(i||""),t.addEventListener("click",(function(t){e.chosenSave=i,e.setButtons(),e.game.getAudioManager().playAudio("select")})),n.push(t)},o=0;o<4;o++)i(o);return(t=document.createElement("button")).id="btn-save",t.innerHTML="Save",t.addEventListener("click",(function(t){e.game.getSaveManager().save(e.chosenSave)&&(e.toggle(),e.game.getAudioManager().playAudio("select"))})),n.push(t),(t=document.createElement("button")).id="btn-load",t.innerHTML="Load",t.addEventListener("click",(function(t){e.game.getSaveManager().load(e.chosenSave)&&(e.game.setStarted(),e.game.getAudioManager().playAudio("select"),e.toggle())})),n.push(t),(t=document.createElement("button")).id="btn-back",t.innerHTML="Back",t.addEventListener("click",(function(t){e.leaderboardOpened&&!e.game.isActive()&&location.reload(),e.setVisibility(!1,!1,!1,!1),e.focusedIndex=0,e.setButtons(),e.game.getAudioManager().playAudio("select")})),n.push(t),n.forEach((function(t,n){t.addEventListener("mouseover",(function(t){e.setFocused(n),e.setButtons()})),e.menu.appendChild(t),t.hidden=!0})),n},t.prototype.setButtons=function(){var t=this;this.saveOpened?(this.title.innerHTML="Save/Load",this.setHidden(!0,!0,!0),this.mainMenuButtons.forEach((function(t){return t.hidden=!0})),this.saveMenuButtons.forEach((function(e){e.classList.remove("focused"),("btn-save"!=e.id||t.game.hasStarted())&&(e.hidden=!1),e.id=="btn-save-".concat(t.chosenSave)?e.classList.add("selected"):e.classList.remove("selected")})),this.saveMenuButtons[this.focusedIndex].classList.add("focused")):this.controlsOpened?(this.title.innerHTML="Controls",this.setHidden(!1,!0,!0),this.mainMenuButtons.forEach((function(t){return t.hidden=!0})),this.saveMenuButtons.forEach((function(t){return t.hidden=!0})),this.saveMenuButtons.at(-1).hidden=!1,this.saveMenuButtons.at(-1).classList.add("focused")):this.audioOpened?(this.title.innerHTML="Audio",this.mainMenuButtons.forEach((function(t){return t.hidden=!0})),this.saveMenuButtons.forEach((function(t){return t.hidden=!0})),this.setHidden(!0,!1,!0),this.saveMenuButtons.at(-1).hidden=!1,this.saveMenuButtons.at(-1).classList.add("focused"),this.game.getAudioManager().loadAudioSettings()):this.leaderboardOpened?(this.title.innerHTML="Leaderboard",this.mainMenuButtons.forEach((function(t){return t.hidden=!0})),this.saveMenuButtons.forEach((function(t){return t.hidden=!0})),this.setHidden(!0,!0,!1),this.saveMenuButtons.at(-1).hidden=!1,this.saveMenuButtons.at(-1).classList.add("focused"),lt.load()):(this.title.innerHTML=this.game.hasStarted()?"Pause":"Game",this.setHidden(!0,!0,!0),this.saveMenuButtons.forEach((function(t){return t.hidden=!0})),this.mainMenuButtons.forEach((function(e){e.hidden=!1,e.classList.remove("focused"),"btn-start"==e.id?e.innerHTML=t.game.hasStarted()?"Resume":"Start":"btn-saves"==e.id&&(e.innerHTML=t.game.hasStarted()?"Save & Load":"Load")})),this.mainMenuButtons[this.focusedIndex].classList.add("focused"))},t.prototype.processEscape=function(){this.saveOpened||this.controlsOpened||this.audioOpened||this.leaderboardOpened?(this.game.getAudioManager().playAudio("select"),this.setVisibility(!1,!1,!1,!1),this.focusedIndex=0,this.setButtons()):this.game.hasStarted()&&(this.game.getAudioManager().playAudio("select"),this.toggle())},t.prototype.setHidden=function(t,e,n){void 0===t&&(t=!0),void 0===e&&(e=!0),void 0===n&&(n=!0),this.controlsList.hidden=t,this.audioSettings.hidden=e,this.leaderboard.hidden=n},t.prototype.setVisibility=function(t,e,n,i){void 0===t&&(t=this.controlsOpened),void 0===e&&(e=this.audioOpened),void 0===n&&(n=this.leaderboardOpened),void 0===i&&(i=this.saveOpened),this.saveOpened=i,this.controlsOpened=t,this.audioOpened=e,this.leaderboardOpened=n},t.prototype.toggle=function(t){void 0===t&&(t=!0),this.mainOpened=!this.mainOpened,this.mainOpened?(this.menuOverlay.classList.remove("hidden"),this.menu.classList.remove("hidden"),this.setButtons(),t&&(this.game.getAudioManager().pauseBackground(),this.game.getAudioManager().stopAllSFX())):(this.menuOverlay.classList.add("hidden"),this.menu.classList.add("hidden"),this.mainMenuButtons.forEach((function(t){return t.hidden=!0})),this.saveMenuButtons.forEach((function(t){return t.hidden=!0})),this.saveOpened=!1,this.focusedIndex=0,this.game.getAudioManager().playBackground())},t.prototype.opened=function(){return this.mainOpened},t.prototype.getFocusedButton=function(){return this.controlsOpened||this.leaderboardOpened||this.audioOpened?this.saveMenuButtons.at(-1):this.saveOpened?this.saveMenuButtons[this.focusedIndex]:this.mainMenuButtons[this.focusedIndex]},t.prototype.setFocused=function(t){this.focusedIndex=t},t.prototype.nextButton=function(){this.controlsOpened||(++this.focusedIndex>=(this.saveOpened?this.saveMenuButtons.length:this.mainMenuButtons.length)&&(this.focusedIndex=0),!this.game.hasStarted()&&this.saveOpened&&this.focusedIndex==this.saveBtnIndex&&this.nextButton(),this.setButtons())},t.prototype.prevButton=function(){this.controlsOpened||(--this.focusedIndex<0&&(this.focusedIndex+=this.saveOpened?this.saveMenuButtons.length:this.mainMenuButtons.length),!this.game.hasStarted()&&this.saveOpened&&this.focusedIndex==this.saveBtnIndex&&this.prevButton(),this.setButtons())},t.prototype.endScreen=function(t){void 0===t&&(t=!0),this.menuOverlay.classList.remove("hidden");var e=document.getElementById("game-result"),n=document.getElementById("form"),i=document.getElementById("username");e.hidden=!1,n.hidden=!1,i.value=localStorage.getItem("username")||"Player",e.innerHTML=t?"GAME OVER":"YOU WON!",this.game.getAudioManager().stopBackground(),this.game.getAudioManager().playAudio(t?"loss":"win")},t.prototype.setEndButtonListener=function(){var t=this,e=document.getElementById("game-result"),n=document.getElementById("form"),i=document.getElementById("username");document.getElementById("btn-end").addEventListener("click",(function(o){o.preventDefault();var s=i.value;localStorage.setItem("username",s||"Player"),lt.update({name:s,score:t.game.getPlayer().getScore()}),t.leaderboardOpened=!0,t.toggle(!1),e.hidden=!0,n.hidden=!0}))},t}(),gt=function(){function t(){this.gameStarted=!1,this.gameActive=!1,this.playersTurn=!0,this.objectStorage=new ut,this.mapManager=new U,this.spriteManager=new V,this.eventManager=new q,this.audioManager=new P,this.saveManager=new Z,this.dialogue=new x,this.entities=[],this.items=[],this.events=[],this.startRules=[],this.finishRules=[]}return t.getInstance=function(){return this.instance||(this.instance=new t),this.instance},t.prototype.start=function(){return t=this,e=void 0,i=function(){var t,e,n,i=this;return function(t,e){var n,i,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,i&&(o=2&s[0]?i.return:s[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,s[1])).done)return o;switch(i=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,i=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],i=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}}(this,(function(o){switch(o.label){case 0:return this.gameActive=!0,this.menu=new dt,[4,this.spriteManager.readSprites()];case 1:return o.sent(),[4,this.mapManager.readTiles()];case 2:return o.sent(),[4,this.audioManager.readAudio()];case 3:return o.sent(),this.objectStorage.readEnemies(),this.objectStorage.readNPCs(),this.objectStorage.readItems(),this.drawManager=new z,this.drawManager.addResizeListener(),this.player=new B,this.spriteManager.setPlayerSprite(this.player),this.mapManager.loadMap(),t=0,e=0,n=function(o){var s,a,r;i.menu.opened()||(i.playersTurn?i.eventManager.hasAction()&&(i.performAction(i.eventManager.getAction()),null===(a=i.eventManager)||void 0===a||a.clearActions()):i.processEntities(),o-t>=1e3&&(null===(r=i.drawManager)||void 0===r||r.toggleAnimFrame(),t=o,e++>=4&&((s=i.audioManager).playAudio.apply(s,i.getRandEnemySound()),e=0)),i.drawManager.clear(),i.drawManager.drawField(i.mapManager.getField()),i.drawManager.drawInfo(),i.drawManager.drawLog(),i.drawManager.drawDialogue()),i.gameActive&&window.requestAnimationFrame(n)},window.requestAnimationFrame(n),[2]}}))},new((n=void 0)||(n=Promise))((function(o,s){function a(t){try{h(i.next(t))}catch(t){s(t)}}function r(t){try{h(i.throw(t))}catch(t){s(t)}}function h(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,r)}h((i=i.apply(t,e||[])).next())}));var t,e,n,i},t.prototype.endGame=function(){var t;this.gameActive=!1,null===(t=this.menu)||void 0===t||t.endScreen(this.player.getHP()<=0)},t.prototype.playerActed=function(){var t;this.clearEvents(),null===(t=this.drawManager)||void 0===t||t.clearPlayerAction(),this.playersTurn=!1},t.prototype.isActive=function(){return this.gameActive},t.prototype.hasStarted=function(){return this.gameStarted},t.prototype.setStarted=function(){this.gameStarted=!0},t.prototype.clearMap=function(){this.entities.length=0,this.items.length=0,this.clearEvents(),this.clearRules()},t.prototype.getPlayer=function(){return this.player},t.prototype.getItems=function(){return this.items},t.prototype.setPlayer=function(t){var e,n,i=this.mapManager.getField();if(t)i.cellAt(t).setEntity(this.player),null===(e=this.player)||void 0===e||e.setPos(t);else for(var o=0;o<i.getWidth();o++)for(var s=0;s<i.getHeigth();s++)if(i.cellAt(new h(o,s)).isStart()){i.cellAt(new h(o,s)).setEntity(this.player),null===(n=this.player)||void 0===n||n.setPos(new h(o,s));break}this.removeDuplicateKeyItems()},t.prototype.addEntity=function(t){this.entities.push(t)},t.prototype.addItem=function(t){this.items.push(t)},t.prototype.processEntities=function(){this.entities.forEach((function(t){return t.act()})),this.playersTurn=!0},t.prototype.removeEntity=function(t,e){var n=this;void 0===e&&(e=!1),this.entities=this.entities.filter((function(i){return i!=t||(e&&n.mapManager.getField().cellAt(t.getPos()).setEntity(null),!1)}))},t.prototype.removeItem=function(t,e){var n=this;void 0===e&&(e=!1),this.items=this.items.filter((function(i){return i!=t||(e&&n.mapManager.getField().cellAt(t.getPos()).setItem(null),!1)}))},t.prototype.removeItemByName=function(t,e){var n=this;void 0===e&&(e=!1),this.items=this.items.filter((function(i){return i.getName()!=t||(e&&n.mapManager.getField().cellAt(i.getPos()).setItem(null),!1)}))},t.prototype.removeDuplicateKeyItems=function(t){var e,n=this;t?this.removeItemByName(t,!0):null===(e=this.player)||void 0===e||e.getKeyItems().forEach((function(t){n.removeItemByName(t,!0)}))},t.prototype.getRandEnemySound=function(){var t=this.entities.filter((function(t){return t instanceof w}));if(0===t.length)return["",0];var e=t[Math.floor(Math.random()*t.length)];return[e.getSound(),1/Math.min(Math.max(1,e.getPos().dist(this.player.getPos())/4),5)]},t.prototype.getEntities=function(){return this.entities},t.prototype.setObjects=function(t,e,n){this.clearMap(),this.entities=t,this.items=e,this.player=n,this.setPlayer(n.getPos()),A()},t.prototype.pushEvent=function(t){this.events.push(t)},t.prototype.clearEvents=function(){this.events.length=0},t.prototype.getEvents=function(){return this.events},t.prototype.addRule=function(t,e){void 0===e&&(e=!0),e?this.startRules.push(t):this.finishRules.push(t)},t.prototype.getRules=function(t){return void 0===t&&(t=!0),t?this.startRules:this.finishRules},t.prototype.clearRules=function(t){void 0===t&&(t=!0),t?this.startRules.length=0:this.finishRules.length=0},t.prototype.getMenu=function(){return this.menu},t.prototype.getDialogue=function(){return this.dialogue},t.prototype.getSaveManager=function(){return this.saveManager},t.prototype.getController=function(){return this.eventManager},t.prototype.getStorage=function(){return this.objectStorage},t.prototype.getSpriteManager=function(){return this.spriteManager},t.prototype.getMapManager=function(){return this.mapManager},t.prototype.getAudioManager=function(){return this.audioManager},t.prototype.msg=function(t){console.log(t)},t.prototype.changeScale=function(t){var e;null===(e=this.drawManager)||void 0===e||e.changeScale(this.drawManager.getScale()+t)},t.prototype.performAction=function(t){switch(t){case J.MOVE:this.player.move(this.eventManager.getDirection());break;case J.HIT:this.player.hit(this.eventManager.getDirection());break;case J.CAST:this.player.castSpell(this.eventManager.getDirection());break;case J.SLEEP:this.player.sleep(),this.drawManager.playerRest();break;case J.PICK_UP:this.player.pickUp(),this.drawManager.playerDrop();break;case J.BUFF:this.player.drinkPotion(),this.drawManager.playerDrink();break;case J.DROP_W:this.player.dropWeapon(),this.drawManager.playerDrop();break;case J.DROP_S:this.player.dropSpell(),this.drawManager.playerDrop();break;case J.DROP_A:this.player.dropArmor(),this.drawManager.playerDrop();break;case J.DROP_P:this.player.dropPotion(),this.drawManager.playerDrop();break;case J.END:this.endGame();break;case J.QSAVE:this.msg("Quick saving..."),this.saveManager.save(0);break;case J.QLOAD:this.msg("Quick loading..."),this.saveManager.load(0)}},t}();gt.getInstance().start()})()})();